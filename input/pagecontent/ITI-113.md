This section corresponds to the transaction ITI-113 Resource Subscription Search of the IHE Technical Framework. Transaction [ITI-113] Resource Subscription Search is used by the Resource Notification Subscriber and Resource Notification Broker actors. The Resource Subscription Search [ITI-113] transaction is used to query Subscription and get back the results. 

### 3.113.1 Scope

The Resource Subscription Search [ITI-113] transaction passes a Resource Subscription Search from a Resource Notification Subscriber to a Resource Notification Broker.

### 3.113.2 Actors Roles

**Table: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Subscriber](volume-1.html#subscriber)     | Sends the query request to the Resource Notification Broker |
| [Resource Notification Broker](volume-1.html#broker) | Receives the query and responds |

### 3.113.3 Referenced Standards

**FHIR-R4B** [HL7 FHIR Release 4.3.0](https://www.hl7.org/FHIR/R4B)

### 3.113.4 Interactions

<figure>
{%include ITI-113-Subscription-seq.svg%}
<figcaption><b>Figure 2:3.113: ITI-113 interactions</b></figcaption>
</figure>
<br clear="all">

### 3.113.5 Resource Subscription Search Request Message
The Resource Notification Subscriber Request Message is a parametrized `HTTP GET` that allows to search for a list of Subscription resources managed by the Resource Notification Broker, based on a set of search parameters.

#### 3.113.5.1 Trigger Events

A Resource Notification Subscriber sends this message to the Resource Notification Broker when it needs to discover a Subscription Resource.  

#### 3.113.5.2 Message Semantics

The Resource Notification Subscriber sends an `HTTP GET` request to the Resource Notification Broker. This request shall comply with requirements specified in the HL7<sup>®</sup>
FHIR<sup>®</sup> standard <https://hl7.org/fhir/R4/http.html#search>.

The search target URL follows the FHIR HTTP specification <https://hl7.org/fhir/R4B/http.html>, addressing the resource type that the Resource Notification Subscriber is interested to discover. 

The Resource Notification Subscriber Request Message can be expressed by addressing the Subscription Resource with different parameters:
 
>GET  \[base\]/Subscription?\[Parameters\]

The Resource Notification Subscriber may provide the optional parameter "_format" to specify the desired MIME-types in the response message. The Resource Notification Broker should accept `application/fhir+xml` and `application/fhir+json` as _format parameters.  For example, indicating `application/fhir+json` could result in the response from the Resource Notification Broker being a json FHIR Bundle with all the content encoded as FHIR resources.

##### 3.113.5.2.1 Query Parameters
The query parameters allowed are the parameters indicated in the [Search parameters](https://hl7.org/fhir/R4B/subscription.html#search) section.  

<table class="list">
   <tbody>
      <tr>
         <td><b>Name</b></td>
         <td><b>Type</b></td>
         <td><b>Element</b></td>
         <td><b>Description</b></td>
      </tr>
      <tr>
         <td><a > </a>contact</td>
         <td><a >token</a></td>
         <td>Subscription.contact</td>
         <td>Contact details for the subscription</td>
      </tr>
      <tr>
         <td><a > </a>criteria</td>
         <td><a >string</a></td>
         <td>Subscription.criteria</td>
         <td>The search rules used to determine when to send a notification</td>
      </tr>
      <tr>
         <td><a > </a>payload</td>
         <td><a >token</a></td>
         <td>Subscription.channel.payload</td>
         <td>The mime-type of the notification payload</td>
      </tr>
      <tr>
         <td><a > </a>status</td>
         <td><a >token</a></td>
         <td>Subscription.status</td>
         <td>The current state of the subscription</td>
      </tr>
      <tr>
         <td><a > </a>type</td>
         <td><a >token</a></td>
         <td>Subscription.channel.type</td>
         <td>The type of channel for the sent notifications</td>
      </tr>
      <tr>
         <td><a > </a>url</td>
         <td><a >uri</a></td>
         <td>Subscription.channel.endpoint</td>
         <td>The URI that will receive the notifications</td>
      </tr>
   </tbody>
</table>

The Resource Notification Broker should support also the [search parameter](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/artifacts.html#behavior-search-parameters) included in the Subscription R5 Backport Implementation Guide.

###### 3.113.5.2.1.1 Subscription search examples

Search for all active subscriptions with `endpoint=X` without expliciting the type of subscription: 
>GET  \[base\]/Subscription?status=active&channel.endpoint=X

Search for all the subscription made for documents produced for a specific patient with `patientId = Y`:
>GET  \[base\]/Subscription?filter-criteria=documentReference%3Fsubject=Y

Search for all the subscription that are refererring to a specific SubscriptionTopic resource with `id=1234`:
>GET  \[base\]/Subscription?criteria=http://hl7.org/SubscriptionTopic/1234

#### 3.113.5.3 Expected Actions

The Resource Notification Broker who received the message shall process the request and respond with the results of the search.

### 3.113.6 Resource Subscription Search Response Message
The Resource Notification Broker returns an HTTP status code appropriate to the processing as well as a Bundle containing a list of the matching Subscription resources.

#### 3.113.6.1 Trigger Events

The Resource Notification Broker completed the processing of the request message.

#### 3.113.6.2 Message Semantics

Based on the query results, the Resource Notification Broker will either return an error or success. Guidance on handling Access Denied related to the use of 200, 403, and 404 can be found in ITI TF-2x: [Appendix Z.7](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.7-guidance-on-access-denied-results).When the Resource Notification Broker needs to report an error, it shall use HTTP error response codes and should include a FHIR OperationOutcome with more details on the failure. See FHIR https://hl7.org/fhir/R4B/http.html and https://hl7.org/fhir/R4B/operationoutcome.html.

If the Resource Subscription Search message is processed successfully, whether or not any Subscription Resources are found, the response shall be an `HTTP 200` status code. The Resource Subscription Search Response message shall be a Bundle Resource containing zero or more Subscription resources. If the Document Responder is sending warnings, the Bundle Resource shall also contain an OperationOutcome Resource that contains those warnings.

The response shall adhere to the FHIR Bundle constraints specified in ITI TF-2x: [Appendix Z.7](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.1-resource-bundles)

#### 3.113.6.3 Expected Actions
The Resource Notification Subscriber shall process the results according to application-defined rules.

### CapabilityStatement Resource

The Server implementing this transaction shall provide a CapabilityStatement Resource as described in ITI TF-2x: Appendix Z.3 indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [Client](CapabilityStatement-IHE.ToDo.client.html)
* Requirements CapabilityStatement for [Server](CapabilityStatement-IHE.ToDo.server.html)

### Security Considerations

See [DSUBm Security Considerations](volume-1.html#security-considerations). 

The implementers should be aware that a specific Resource Notification Subscriber may acquire sensitive information if searching fo Subscription created by other Subscribers. 
The Resource Notification Broker should follow an implementing policy in order to allow or prohibit the search for Subscription resource created by other Subscribers. 



#### Security Audit Considerations

''TODO: The security audit criteria ''

##### Client Audit 

''TODO: the specifics''

##### Server Audit 

''TODO: the specifics''
