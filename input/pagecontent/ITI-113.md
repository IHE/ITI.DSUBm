This section corresponds to the transaction ITI-113 Resource Subscription Search of the IHE Technical Framework. Transaction [ITI-113] Resource Subscription Search is used by the Resource Notification Subscriber and Resource Notification Broker actors. The Resource Subscription Search [ITI-113] transaction is used to query Subscription and get back the results. 

### 3.113.1 Scope

The Resource Subscription Search [ITI-113] transaction passes a Resource Subscription Search message from a Resource Notification Subscriber to a Resource Notification Broker in order to discover Subscription, to be aware of Subscriptions status or to be aware of previous events related to Subscriptions.

### 3.113.2 Actors Roles

**Table: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Subscriber](volume-1.html#subscriber)     | Sends the query request to the Resource Notification Broker |
| [Resource Notification Broker](volume-1.html#broker) | Receives the query and responds |
{: .grid}

### 3.113.3 Referenced Standards

**FHIR-R4** [HL7 FHIR Release 4.0.](https://www.hl7.org/FHIR/R4)

### 3.113.4 Interactions

<figure>
{%include ITI-113-Subscription-seq.svg%}
<figcaption><b>Figure 2:3.113: ITI-113 interactions</b></figcaption>
</figure>
<br clear="all">

### 3.113.5 Resource Subscription Search Request Message
The Resource Notification Subscriber Request Message is a parametrized `HTTP GET` that allows to search or retrieve, from the Resource Notification Broker, informations about Subscriptions.

#### 3.113.5.1 Trigger Events

A Resource Notification Subscriber sends this message to the Resource Notification Broker when it needs to discover one or more Subscription Resource that is not known. 

This message can be used by the Resource Notification Subscriber to be aware of the status of one or more Subscription, using the $status operation. 

When the Subscription Resource is known, this message can be used by the Resource Notification Subscriber to be aware of previous events related to that Subscription, using the $event operation.

#### 3.113.5.2 Message Semantics

The Resource Notification Subscriber sends an `HTTP GET` request to the Resource Notification Broker. This request shall comply with requirements specified in the HL7<sup>®</sup>
FHIR<sup>®</sup> standard <https://hl7.org/fhir/R4/http.html#search>.

The Resource Notification Subscriber may provide the optional parameter "_format" to specify the desired MIME-types in the response message. The Resource Notification Broker should accept `application/fhir+xml` and `application/fhir+json` as _format parameters.  For example, indicating `application/fhir+json` could result in the response from the Resource Notification Broker being a json FHIR Bundle with all the content encoded as json FHIR resources.

#### 3.113.5.2.1 Subscription Search

The search target URL follows the FHIR HTTP specification <https://hl7.org/fhir/R4/http.html>, addressing the Subscription Resources that the Resource Notification Subscriber is interested to discover. 

The Resource Notification Subscriber Request Message can be expressed by addressing the Subscription Resource with different parameters at the URL:
 
>GET  \[base\]/Subscription?\[Parameters\]

The query parameters allowed, reported in Table 3.113.5.2.1-1,  are the parameters indicated in the [Search parameters](https://hl7.org/fhir/R4B/subscription.html#search) section and also the [search parameter](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/artifacts.html#behavior-search-parameters) included in the [Subscription R5 Backport Implementation Guide](http://hl7.org/fhir/uv/subscriptions-backport/STU1.1/).  


**Table 3.113.5.2.1-1: Search Parameters**

|Name	|Type	|	Description |
|--------------|----------------|-----------|
|contact	|token	|	Contact details for the subscription|
|criteria	|string	|	The search rules used to determine when to send a notification|
|payload|	token		|The mime-type of the notification payload|
|status	|token	|The current state of the subscription|
|type	|token		|The type of channel for the sent notifications|
|url	|uri		|The URI that will receive the notifications|
|custom-channel|string|This SearchParameter enables query of subscriptions by additional channel type|
|filter-criteria|string|This SearchParameter enables query of subscriptions by filter criteria|
|payload-type|string|This SearchParameter enables query of subscriptions by payload type|
|topic|uri|This SearchParameter enables query of subscriptions by canonical topic-url|
{: .grid}


##### 3.113.5.2.1.1 Subscription search examples

Search for all active subscriptions with `endpoint=X` without expliciting the type of subscription: 
>GET  \[base\]/Subscription?status=active&channel.endpoint=X

Search for all the subscription made for documents produced for a specific patient with `patientId = Y`:
>GET  \[base\]/Subscription?filter-criteria=documentReference%3Fsubject=Y

Search for all the subscription that are refererring to a specific SubscriptionTopic resource with `id=1234`:
>GET  \[base\]/Subscription?criteria=http://hl7.org/SubscriptionTopic/1234


#### 3.113.5.2.2 $status operation

The Resource Notification Subscriber Request Message could be a FHIR operation request as defined in FHIR (http://hl7.org/fhir/operations.html) with the $status operation definition and the input parameters in Table 3.113.5.2.2-1, in order to be aware of the Subscriptions status.

The URL for this operation is one of:

>GET  \[base\]/Subscription/$status

>GET  \[base\]/Subscription/\[id\]/$status

**Table 3.113.5.2.2-1: $status operation Parameters**

|Name	|Cardinality|Type	|	Description |
|-----------|------|----------------|-----------|
|id	| 0..* |id	|	At the Instance level, this parameter is ignored. At the Resource level, one or more parameters containing a FHIR id for a Subscription to get status information for. In the absence of any specified ids, the server returns the status for all Subscriptions available to the caller. Multiple values are joined via OR (e.g., "id1" OR "id2")|
|status	| 0..* |code	|	At the Instance level, this parameter is ignored. At the Resource level, a Subscription status to filter by (e.g., "active"). In the absence of any specified status values, the server does not filter contents based on the status. Multiple values are joined via OR (e.g., "error" OR "off")|
{: .grid}

#### 3.113.5.2.3 $event operation

The Resource Notification Subscriber Request Message could be a FHIR operation request as defined in FHIR (http://hl7.org/fhir/operations.html) with the $event operation definition and the input parameters in Table 3.113.5.2.3-1, in order to be aware of previous events related to a Subscription.

The URL for this operation is:

>GET  \[base\]/Subscription/\[id\]/$event

**Table 3.113.5.2.3-1: $event operation Parameters**

|Name	|Cardinality|Type	|	Description |
|--------------|----------|----------------|-----------|
|eventsSinceNumber| 0..1	|string	|	The starting event number, inclusive of this event (lower bound)	|
|eventsUntilNumber| 0..1	|string	|The ending event number, inclusive of this event (upper bound)	|
|content| 0..1	|code	|Requested content style of returned data. Codes from backport-content-value-set (e.g., empty, id-only, full-resource). This is a hint to the server what a client would prefer, and MAY be ignored	|
{: .grid}

#### 3.113.5.3 Expected Actions

The Resource Notification Broker who received the message shall process the request and respond with a Resource Subscription Search Response Message. 

If receved a Subscription Search request, the Resource Notification Broker shall evaluate to return in response a Bundle with the Subscription Resurces that matches the query parameters in the request message.

If receved a $status operation request, the Resource Notification Broker shall evaluate to return in response a Bundle with the SubscriptionStatus Resurces related to the Subscription that matches the query parameters in the request message.

If receved a $event operation request, the Resource Notification Broker shall evaluate to return in response a Bundle with the SubscriptionStatus Resurce and the previous events related to the Subscription that match the query parameters in the request message.

### 3.113.6 Resource Subscription Search Response Message
The Resource Notification Broker returns an HTTP status code appropriate to the processing as well as a Bundle containing a list of the matching Subscription and/or SubscriptionStatus resources.

#### 3.113.6.1 Trigger Events

The Resource Notification Broker completed the processing of the request message.

#### 3.113.6.2 Message Semantics

The response shall adhere to the FHIR Bundle constraints specified in ITI TF-2x: [Appendix Z.7](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.1-resource-bundles)

Based on the query results, the Resource Notification Broker will either return an error or success. Guidance on handling Access Denied related to the use of 200, 403, and 404 can be found in ITI TF-2x: [Appendix Z.7](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.7-guidance-on-access-denied-results). When the Resource Notification Broker needs to report an error, it shall use HTTP error response codes and should include a FHIR OperationOutcome with more details on the failure. See FHIR https://hl7.org/fhir/R4/http.html and https://hl7.org/fhir/R4/operationoutcome.html.


#### 3.113.6.2.1 Subscription Search response

If the Resource Subscription Search message is processed successfully, whether or not any Subscription Resources are found based on the request parameter, the response shall be an `HTTP 200` status code. The Resource Subscription Search Response message shall be a Bundle Resource that shall have:

 - the `Bundle.type` element valued `searchset` 
 - zero or more entries containing the Subscription Resources; 
 - zero or one OperationOutcome Resource that contains warnings, if the Resource Subscription Broker is sending warnings. 
 
 More information about search response can be found at [http://hl7.org/fhir/R4/http.html#search](http://hl7.org/fhir/R4/http.html#search).

#### 3.113.6.2.2 $status operation response

If the $status operation request is processed successfully the response shall be an `HTTP 200` status code. The Resource Subscription Search Response message shall be a Bundle Resource that shall have:

 - the `Bundle.type` element valued `searchset` 
 - zero or more entries containing the [SubscriptionStatus]() Resources for the $status operation; 
 - zero or one OperationOutcome Resource that contains warnings, if the Resource Subscription Broker is sending warnings. 
 
 More information about search response can be found at [http://hl7.org/fhir/R4/http.html#search](http://hl7.org/fhir/R4/http.html#search).


#### 3.113.6.2.3 $event operation response

If the $event operation request is processed successfully the response shall be an `HTTP 200` status code. The Resource Subscription Search Response message shall be a Bundle Resource that shall have:

 - the `Bundle.type` element valued `history` 
 - in the first the first entry the [SubscriptionStatus]() for the $event operation;
 - zero or more additional entries, with either URLs or resources representing contents, depending on the `conent` query parameter in the request and the `Subscription.payload.content` and the `notificationShape` element defined in the Topic of the Subscription. 

with type = `searchset` containing as the first entry the SubscriptionStatus Resources related to the Subscription and zero or more additional entries, with either URLs or resources representing contents, depending on the `Subscription.payload.content` and the `notificationShape` defined in the Topic of the Subscription.

#### 3.113.6.3 Expected Actions
The Resource Notification Subscriber shall process the results according to application-defined rules.

### CapabilityStatement Resource

The Server implementing this transaction shall provide a CapabilityStatement Resource as described in ITI TF-2x: Appendix Z.3 indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [Client](CapabilityStatement-IHE.ToDo.client.html)
* Requirements CapabilityStatement for [Server](CapabilityStatement-IHE.ToDo.server.html)

### Security Considerations

See [DSUBm Security Considerations](volume-1.html#security-considerations). 

The implementers should be aware that a specific Resource Notification Subscriber may acquire sensitive information if searching fo Subscription created by other Subscribers. 
The Resource Notification Broker should follow an implementing policy in order to allow or prohibit the search for Subscription resource created by other Subscribers. 

It's highly recommended that the Resource Notification Subscriber should use some form of authentication method when searching for existing Subscription. The Resource Notification Broker should always verify the authentication token used in this transaction before returning the information requested. 

#### Security Audit Considerations

The Resource Notification Subscriber, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record a [Subscription Search Subscriber Audit Event Log](StructureDefinition-IHE.DSUBm.SearchSubscription.Audit.Subscriber.html).  !!! TO DO ARTIFACT !!!!

The Resource Notification Broker, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record a [Subscription Search Broker Audit Event Log](StructureDefinition-IHE.DSUBm.SearchSubscription.Audit.Broker.html).  !!! TO DO ARTIFACT !!!!

The Resource Notification Subscriber and Resource Notification Broker may also record fundamental AuditEvents for each individual resource Created or Updated, using the [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [basic profile for REST events](https://profiles.ihe.net/ITI/BALP/content.html#3573-restful-activities).