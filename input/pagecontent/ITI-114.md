This section corresponds to the Resource SubscriptionTopic Search [ITI-114] transaction of the IHE Technical Framework.

### 2:3.114.1 Scope

The Resource SubscriptionTopic Search [ITI-114] is used by the Resource Notification Subscriber to Resource Notification Broker actors, in order to search for a SubscriptionTopic to be used in a Subscription.

### 2:3.114.2 Actors Roles

**Table 2:3.114.2-1: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Subscriber](volume-1.html#154112-resource-notification-subscriber)     | Sends the query request to the Resource Notification Broker |
| [Resource Notification Broker](volume-1.html#154111-resource-notification-broker) | Receives the query and responds |
{: .grid}

### 2:3.114.3 Referenced Standards

**FHIR-R4B** [HL7 FHIR Release 4.3.0](https://www.hl7.org/FHIR/R4B)

### 2:3.114.4 Interactions

<figure>
{%include ITI-114-SubscriptionTopic-seq.svg%}
<figcaption><b>Figure 2:3.114.4-1: Resource SubscriptionTopic Search [ITI-114] interactions</b></figcaption>
</figure>
<br clear="all">

### 2:3.114.5 Resource SubscriptionTopic Search Request Message
The Resource Notification Subscriber Request Message is a parametrized `HTTP GET` that allows to search for a list of SubscriptionTopic resources managed by the Resource Notification Broker, based on a set of search parameters.

#### 2:3.114.5.1 Trigger Events

A Resource Notification Subscriber sends this message to the Resource Notification Broker when it needs to discover a SubscriptionTopic resource. This normally happens before the Subscriber creates a subscription.

#### 2:3.114.5.2 Message Semantics

The Resource Notification Subscriber sends an HTTP GET request to the Resource Notification Broker. This request shall comply with requirements specified in the HL7<sup>®</sup>
FHIR<sup>®</sup> standard <https://hl7.org/fhir/R4B/http.html#search>.

The Resource Notification Subscriber Request Message shall be expressed by addressing the SubscriptionTopic Resource in the path as follows:

> GET \[base\]/SubscriptionTopic?\[Parameters\]

The Resource Notification Subscriber may provide the optional parameter "_format" to specify the desired MIME-types in the response message. The Resource Notification Broker should accept `application/fhir+xml` and `application/fhir+json` as _format parameters.  For example, indicating `application/fhir+json` could result in the response from the Resource Notification Broker being a json FHIR Bundle with all the content encoded as FHIR resources.

In the request message the query parameters allowed from the [Search Parameters](https://hl7.org/fhir/R4B/subscriptiontopic.html#search) of the [SubscriptionTopic](https://hl7.org/fhir/R4B/subscriptiontopic.html) Resource are:

**Table 2:3.114.5.2-1: Resource SubscriptionTopic Search Request Message Search Parameters**

|Name	|Type	|	Description |
|--------------|----------------|-----------|
|resource	|uri	|	Allowed Data type or Resource (reference to definition) for this definition, searches resourceTrigger, eventTrigger, and notificationShape for matches.|
|derived-or-self |uri |	A server defined search that matches either the url or derivedFrom|
|status	| token	| Recommended value should be `active` when searching for available SubscriptionTopic resources 	|
|url	|	uri	| Logical canonical URL to reference this SubscriptionTopic (globally unique)	|
{: .grid}


#### 2:3.114.5.3 Expected Actions

The Resource Notification Broker who received the message shall process the request, according to application-defined rules, and also evaluate if the Resource Notification Subscriber can access the information. 

If the access is granted, the Resource Notification Broker shall produce a response in which shall be present at least the following SubscriptionTopic Resources:

- Patient-Dependent DocumentReference SubscriptionTopic
- Multi-Patient DocumentReference SubscriptionsTopic
- Patient-Dependent Folder SubscriptionTopic
- Patient-Dependent SubmissionSet SubscriptionTopic
- Multi-Patient SubmissionSet SubscriptionTopic

If the Resource Notification Broker supports the [Updates to document sharing resources option](volume-1.html#15421-updates-to-document-sharing-resources-option), the following SubscriptionTopic resources shall also be present:

- Patient-Dependent DocumentReference SubscriptionTopic with updates to document sharing resources option to document sharing resources option
- Multi-Patient DocumentReference SubscriptionTopic with Updates to document sharing resources option
- Patient-Dependent Folder SubscriptionTopic with Updates to document sharing resources option


### 2:3.114.6 Resource SubscriptionTopic Search Response Message

The Resource Notification Broker returns an HTTP status code appropriate to the processing as well as a Bundle containing a list of the SubscriptionTopic resources.

#### 2:3.114.6.1 Trigger Events

The Resource Notification Broker completed the processing of the request message.

#### 2:3.114.6.2 Message Semantics

Based on the query results, the Resource Notification Broker will either return an error or success. Guidance on handling Access Denied related to the use of 200, 403, and 404 can be found in ITI TF-2x: [Appendix Z.7](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.7-guidance-on-access-denied-results). When the Resource Notification Broker needs to report an error, it shall use HTTP error response codes and should include a FHIR OperationOutcome with more details on the failure. See FHIR [https://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) and [https://hl7.org/fhir/R4B/operationoutcome.html](https://hl7.org/fhir/R4B/operationoutcome.html).

If the Resource SubscriptionTopic Search message is processed successfully, the HTTP status code shall be 200. The Resource SubscriptionTopic Search Response message shall be a Bundle Resource containing the SubscriptionTopic Resources. If the Resource Notification Broker is sending warnings, the Bundle Resource shall also contain an OperationOutcome Resource that contains those warnings.

The response shall adhere to the FHIR Bundle constraints specified in ITI TF-2x: [Appendix Z.7](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.1-resource-bundles)

#### 2:3.114.6.3 Expected Actions

The Resource Notification Subscriber shall process the results according to application-defined rules and be aware of the SubscriptionTopic supported by the Resource Notification Broker.

### 2:3.114.7 CapabilityStatement Resource
The Resource Notification Subscriber implementing this transaction shall provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
- FHIR Capability Statement for [Resource Notification Subscriber](CapabilityStatement-IHE.DSUBm.ResourceNotificationSubscriber.html)
- FHIR Capability Statement for [Resource Notification Subscriber](CapabilityStatement-IHE.DSUBm.ResourceNotificationSubscriber.UpdateOption.html) that support the [Updates to document sharing resources](volume-1.html#15421-updates-to-document-sharing-resources-option) option.

The Resource Notification Broker implementing this transaction shall provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
- FHIR Capability Statement for [Resource Notification Broker](CapabilityStatement-IHE.DSUBm.ResourceNotificationBroker.html)
- FHIR Capability Statement for [Resource Notification Broker](CapabilityStatement-IHE.DSUBm.ResourceNotificationBroker.UpdateOption.html) that support the [Updates to document sharing resources](volume-1.html#15421-updates-to-document-sharing-resources-option) option.

### 2:3.114.8 Security Considerations

See [DSUBm Security Considerations](volume-1.html#1545-security-considerations). 

#### 2:3.114.8.1 Security Audit Considerations

The Resource Notification Subscriber, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record fundamental AuditEvents for:
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Query](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Query.html), when a search interaction is performed;
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Read](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Read.html), when a read interaction is performed.

The Resource Notification Broker, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record fundamental AuditEvents for:
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Query](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Query.html), when a search interaction is performed;
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Read](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Read.html), when a read interaction is performed.
