This section corresponds to the Resource SubscriptionTopic Search [ITI-114] transaction of the IHE Technical Framework.

### 2:3.114.1 Scope

The Resource SubscriptionTopic Search [ITI-114] is used by the Resource Notification Subscriber to Resource Notification Broker actors, in order to search for a SubscriptionTopic to be used in a Subscription.

### 2:3.114.2 Actors Roles

**Table 2:3.114.2-1: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Subscriber](volume-1.html#154112-resource-notification-subscriber)     | Sends the query request to the Resource Notification Broker |
| [Resource Notification Broker](volume-1.html#154111-resource-notification-broker) | Receives the query and responds |
{: .grid}

### 2:3.114.3 Referenced Standards

**FHIR-R4B** [HL7 FHIR Release 4.3.0](https://www.hl7.org/FHIR/R4B)

### 2:3.114.4 Interactions

<figure>
{%include ITI-114-SubscriptionTopic-seq.svg%}
<figcaption><b>Figure 2:3.114.4-1: Resource SubscriptionTopic Search [ITI-114] interactions</b></figcaption>
</figure>
<br clear="all">

### 2:3.114.5 Resource SubscriptionTopic Search Request Message
The Resource Notification Subscriber Request Message is a parametrized `HTTP GET` that allows to search for a list of SubscriptionTopic resources managed by the Resource Notification Broker, based on a set of search parameters.

#### 2:3.114.5.1 Trigger Events

A Resource Notification Subscriber sends this message to the Resource Notification Broker when it needs to discover a SubscriptionTopic resource. This normally happens before the Subscriber creates a subscription.

#### 2:3.114.5.2 Message Semantics

The Resource Notification Subscriber sends an HTTP GET request to the Resource Notification Broker. This request SHALL comply with requirements specified in the HL7<sup>®</sup>
FHIR<sup>®</sup> standard <https://hl7.org/fhir/R4/http.html#search>.

The Resource Notification Subscriber Request Message SHALL be expressed by addressing the SubscriptionTopic Resource in the path as follows:

> GET \[base\]/SubscriptionTopic?\[Parameters\]

The Resource Notification Subscriber should support and MAY supply, and the Resource Notification Broker SHALL be capable of processing all parameters reported in Table 2:3.114.5.2-1. All parameter values SHALL be appropriately encoded per [RFC3986](https://tools.ietf.org/html/rfc3986) “percent” encoding rules. Note that percent encoding does restrict the character set to a subset of ASCII characters which is used for encoding all other characters used in the URL. Resource Notification Broker MAY choose to support additional parameters beyond the subset listed below. Any additional parameters supported SHALL be supported according to [Search Parameters](https://hl7.org/fhir/R4/subscriptiontopic.html#search) section. Such additional parameters are considered out of scope for this transaction. Any additional parameters not supported should be ignored.

FHIR defines methods of supporting multiple parameter values in an AND and OR relationship. The Resource Notification Broker SHALL support both AND and OR relationships. See FHIR specification on Composite Search Parameters [https://hl7.org/fhir/R4/search.html#combining](https://hl7.org/fhir/R4/search.html#combining).


**Table 2:3.114.5.2-1: Resource SubscriptionTopic Search Request Message Search Parameters**

|Name	|Type	|	Description |
|--------------|----------------|-----------|
|_id| string | The id of the SubscriptionTopic|
|resource	|uri	|	Allowed Data type or Resource (reference to definition) for this definition, searches resourceTrigger, eventTrigger, and notificationShape for matches.|
|derived-or-self |uri |	A server defined search that matches either the url or derivedFrom|
|status	| token	| The recommended value should be `active` when searching for available SubscriptionTopic resources 	|
|url	|	uri	| Logical canonical URL to reference this SubscriptionTopic (globally unique)	|
{: .grid}

The Resource Notification Subscriber MAY provide the optional parameter "_format" to specify the desired MIME-types in the response message. The Resource Notification Broker should accept `application/fhir+xml` and `application/fhir+json` as _format parameters.  For example, indicating `application/fhir+json` COULD result in the response from the Resource Notification Broker being a json FHIR Bundle with all the content encoded as FHIR resources.

#### 2:3.114.5.3 Expected Actions

The Resource Notification Broker who received the message SHALL process the request, according to application-defined rules, and also evaluate if the Resource Notification Subscriber can access the information. 

If the access is granted, the Resource Notification Broker SHALL produce a response in which SHALL be present at least the following SubscriptionTopic Resources, if parameters match:

- [Patient-Dependent DocumentReference SubscriptionTopic](Basic-DSUBm-SubscriptionTopic-DocumentReference-PatientDependent.html)
- [Multi-Patient DocumentReference SubscriptionTopic](Basic-DSUBm-SubscriptionTopic-DocumentReference-MultiPatient.html)
- [Patient-Dependent SubmissionSet SubscriptionTopic](Basic-DSUBm-SubscriptionTopic-SubmissionSet-PatientDependent.html)
- [Multi-Patient SubmissionSet SubscriptionTopic](Basic-DSUBm-SubscriptionTopic-SubmissionSet-MultiPatient.html)

If the Resource Notification Broker supports the [DocumentReference Subscription for Minimal Update option](volume-1.html#15421-documentreference-subscription-for-minimal-update-option), the following SubscriptionTopic resources SHALL also be present in the response, if parameters match:

- [Patient-Dependent DocumentReference SubscriptionTopic with DocumentReference Subscription for Minimal Update option](Basic-DSUBm-SubscriptionTopic-DocReference-PatientDependent-MinUpdate.html)
- [Multi-Patient DocumentReference SubscriptionTopic with DocumentReference Subscription for Minimal Update option](Basic-DSUBm-SubscriptionTopic-DocReference-MultiPatient-MinUpdate.html)

If the Resource Notification Broker supports the [DocumentReference Subscription for Full Events option](volume-1.html#15422-documentreference-subscription-for-full-events-option), the following SubscriptionTopic resources SHALL also be present in the response, if parameters match:

- [Patient-Dependent DocumentReference SubscriptionTopic with Updates to document sharing resources option](Basic-DSUBm-SubscriptionTopic-DocReference-PatientDependent-AllEvents.html)
- [Multi-Patient DocumentReference SubscriptionTopic with DocumentReference Subscription for Full Events option](Basic-DSUBm-SubscriptionTopic-DocReference-MultiPatient-AllEvents.html)

If the Resource Notification Broker supports the [Basic Folder Subscription option](volume-1.html#15423-basic-folder-subscription-option), the following SubscriptionTopic resources SHALL also be present in the response, if parameters match:

- [Basic Folder SubscriptionTopic](Basic-DSUBm-SubscriptionTopic-Basic-Folder-Subscription.html)

If the Resource Notification Broker supports the [Folder Subscription for Minimal Update option](volume-1.html#15424-folder-subscription-for-minimal-update-option), the following SubscriptionTopic resources SHALL also be present in the response, if parameters match:

- [Folder SubscriptionTopic with Folder Subscription for Minimal Update option](Basic-DSUBm-SubscriptionTopic-Folder-Subscription-MinUpdateOpt.html)

If the Resource Notification Broker supports the [Folder Subscription for Update option](volume-1.html#15425-folder-subscription-for-update-option), the following SubscriptionTopic resources SHALL also be present in the response, if parameters match:

- [Folder SubscriptionTopic with Folder Subscription for Minimal Update option](Basic-DSUBm-SubscriptionTopic-Folder-Subscription-UpdateOpt.html)

If the Resource Notification Broker supports the [Folder Subscription for Full Events option](volume-1.html#15426-folder-subscription-for-full-events-option), the following SubscriptionTopic resources SHALL also be present in the response, if parameters match:

- [Folder SubscriptionTopic with Folder Subscription for Full Events option option](Basic-DSUBm-SubscriptionTopic-Folder-Subscription-for-Full-Events.html)

### 2:3.114.6 Resource SubscriptionTopic Search Response Message

The Resource Notification Broker returns an HTTP status code appropriate to the processing as well as a Bundle containing a list of the SubscriptionTopic resources.

#### 2:3.114.6.1 Trigger Events

The Resource Notification Broker completed the processing of the request message.

#### 2:3.114.6.2 Message Semantics

Based on the query results, the Resource Notification Broker will either return an error or success. Guidance on handling Access Denied related to the use of 200, 403, and 404 can be found in ITI TF-2x: [Appendix Z.7](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.7-guidance-on-access-denied-results). When the Resource Notification Broker needs to report an error, it SHALL use HTTP error response codes and should include a FHIR OperationOutcome with more details on the failure. See FHIR [https://hl7.org/fhir/R4/http.html](https://hl7.org/fhir/R4/http.html) and [https://hl7.org/fhir/R4/operationoutcome.html](https://hl7.org/fhir/R4/operationoutcome.html).

If the Resource SubscriptionTopic Search message is processed successfully, the HTTP status code SHALL be 200. The Resource SubscriptionTopic Search Response message SHALL be a Bundle Resource containing the SubscriptionTopic Resources. If the Resource Notification Broker is sending warnings, the Bundle Resource SHALL also contain an OperationOutcome Resource that contains those warnings.

The response SHALL adhere to the FHIR Bundle constraints specified in ITI TF-2x: [Appendix Z.7](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.1-resource-bundles)

#### 2:3.114.6.3 Expected Actions

The Resource Notification Subscriber SHALL process the results according to application-defined rules and be aware of the SubscriptionTopic supported by the Resource Notification Broker.

### 2:3.114.7 CapabilityStatement Resource
The Resource Notification Subscriber implementing this transaction SHALL provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
The possible CapabilityStatements for the Resource Notification Subscriber ar listed in Section [1:54.1.1.2 Resource Notification Subscriber](volume-1.html#154112-resource-notification-subscriber).

The Resource Notification Broker implementing this transaction SHALL provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
The possible CapabilityStatements for the Resource Notification Broker ar listed in Section [1:54.1.1.1 Resource Notification Broker](volume-1.html#154111-resource-notification-broker).

### 2:3.114.8 Security Considerations

See [DSUBm Security Considerations](volume-1.html#1545-security-considerations). 

#### 2:3.114.8.1 Security Audit Considerations

The Resource Notification Subscriber, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, SHALL be able to record fundamental AuditEvents for:
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Query](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Query.html), when a search interaction is performed;
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Read](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Read.html), when a read interaction is performed.

The Resource Notification Broker, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, SHALL be able to record fundamental AuditEvents for:
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Query](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Query.html), when a search interaction is performed;
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Read](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Read.html), when a read interaction is performed.
