This section corresponds to the transaction ITI-110 Resource Subscription of the IHE Technical Framework. Transaction [ITI-110] Resource Subscription is used by the Resource Notification Subscriber and Resource Notification Broker actors. The [ITI-110] Resource Subscription transaction is used to submit a subscription in order to get a notification.

### Scope

The Resource Subscription [ITI-110] transaction passes a Resource Subscription Request from a Resource Notification Subscriber to a Resource Notification Broker.

### Actors Roles

**Table: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Subscriber](volume-1.html#subscriber)    | Sends the subscription request to the Resource Notification Broker |
| [Resource Notification Broker](volume-1.html#broker) | Accept the subscription request |

### Referenced Standards

**FHIR-R4B** [HL7 FHIR Release 4.3.0](http://www.hl7.org/FHIR/R4B)

### Interactions

<figure>
{%include ITI-110-seq.svg%}
<figcaption><b>Figure 2:3.110: ITI-110 interactions</b></figcaption>
</figure>
<br clear="all">

#### Resource Subscription Request Message
This message uses the HTTP POST method on the target Resource Notification Broker endpoint to submit the subscritption resource.

##### Trigger Events

This method is invoked when the Resource Notification Subscriber needs to submit one subscription to a Resource Notification Broker. The Resource Notification Subscriber already has discovered the SubscriptionToipic resource supported by the Resource Notification Broker. The SubscriptionToipic discovery may be done with the Resource Subscription Search [ITI-113](ITI-113.html) (see SubscriptionTopic Search option) or by sharing these resources with different methodologies(e.g. Affinity Domain if present).

##### Message Semantics

The Resource Notification Subscriber shall initiate an FHIR “transaction” using a “create” action by sending an HTTP POST request method composed of an FHIR [Subscription](http://hl7.org/fhir/R4B/subscription.html) Resource that supports the [Resource](http://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-subscription.html#root) [Profile: R4/B Topic-Based Subscription](http://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-subscription.html#root). 
In this resource profile the Subscription resource must comply with the SubscriptionTopic resource implemented by the Resource Notification Broker. The Subscription. criteria shall contain the fullUrl that represents the SubscriptionTopic which defines the trigger events that causes a notification and which additional filter criteria the Resource Notification Subscriber may use subscribing on that specific topic. 

The Resource Notification Subscriber actor shall submit the FHIR Subscription resource in either XML format or JSON format thus the media type of the HTTP body shall be either application/fhir+json or application/fhir+xml respectively.

The Resource Subscription message is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](http://hl7.org/fhir/R4B/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol.

###### Subscription Resource 

For document subscription, different types of subscription resources may be submitted to the Resource Notification Broker.

The DSUBm profile specifies the following types of subscriptions:

1. Patient Dependent Subscription resource:
    - a patient identifier shall be contained in the criteria element;
    - the status element shall be requested;
    - the channel.type element must be rest-hook.
    
2. Patient Independent Subscription resource:
    - in the criteria element shall not be present;
    - the status element shall be requested;
    - the channel.type element must be rest-hook.

3. Folder Subscription:
    - a Folder identifier shall be contained in the criteria element;
    - the status element shall be requested;
    - the channel.type element must be rest-hook. 

All the subscription resources should support the following 

For the profiling of these three types of subscription FHIR resources see [here](Subscription_mapping.html)](Subscription_mapping.html) !!!FIX LINK !!!

##### Expected Actions

Upon receiving the request message the Resource Notification Broker shall verify the following conditions: 

- that the SubscriptionTopic (referred in the Subscription.criteria element received in the subscription resource) is valid and implemented by the Resource Notification Broker;
- that all requested filters are defined in the requested topic and are implemented in the Resource Notification Broker;
- that the channel type is known and implemented by the Resource Notification Broker;
- that the channel endpoint is valid for the channel provided (e.g., is it a valid URL of the expected type);
- that the payload configuration is known and implemented by the server
- that the payload configuration is valid for the channel type requested (e.g., complies with the Resource Notification Broker security policy).

Based on the outcome of the these conditions the Resource Notification Broker shall accept/reject the subscription resource received. If all the conditions are true the Resource Notification Broker shall create a subscription resource. 
The Resource Notification Broker actor may support the handshake process to verify that the endpoint included in the subscription resource is reachable. If the Resource Notification Broker actor utilizes the handshake to verify the endpoint included in the subscription resource then the Resource Notification Subscriber shall implement the Subscription Search option. 


#### Resource Subscription Response Message

The Resource Notification Broker sends a Resource Subscription Response message to respond to a Resource Subscription Request message.  

##### Trigger Events

When the Resource Notification Broker has finished creating/rejecting the subscription resource received, the Resource Notification Broker sends this message to the Resource Notification Subscriber acknowledging the result of the creation. 

##### Message Semantics
When the Resource Notification Broker has processed the request, it shall return an HTTP response with an overall status code.
If the subscription criteria element matches at least one SubscriptionTopic implemented the Resource Notification Broker shall respond with an "HTTP 200 OK" and the subscription.status element shall be updated to "active". Otherwise, the Resource Notification Broker shall respond with an "HTTP 400 Bad Request" message and the subscription creation will be unsuccessful. 

##### Expected Actions

The Resource Notification Subscriber processes the response according to application-defined rules.


### CapabilityStatement Resource

Server implementing this transaction shall provide a CapabilityStatement Resource as described in ITI TF-2x: Appendix Z.3 indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [Client](CapabilityStatement-IHE.ToDo.client.html)
* Requirements CapabilityStatement for [Server](CapabilityStatement-IHE.ToDo.server.html)

### Security Considerations 

See [MHD Security Considerations](volume-1.html#security-considerations) TO DO 

#### Security Audit Considerations

''TODO: The security audit criteria ''

##### Client Audit 

''TODO: the specifics''

##### Server Audit 

''TODO: the specifics''
