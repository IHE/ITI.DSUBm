This section corresponds to the transaction [ITI-110] Resource Subscription of the IHE Technical Framework. The [ITI-110] Resource Subscription is used by the Resource Notification Subscriber and Resource Notification Broker actors to submit a subscription in order to receive a notification.

## 3.110.1 Scope

The Resource Subscription [ITI-110] transaction passes a Resource Subscription Request from a Resource Notification Subscriber to a Resource Notification Broker. This transaction can be used to **create a new Subscription** or to **update an existing Subscription**. The update of the subscription is intendet to be used to change an existing subscription or to unsubscribe (deactivate) an existing Subscription. 

## 3.110.2 Actors Roles

**Table: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Subscriber](volume-1.html#subscriber)    | Sends the subscription request to the Resource Notification Broker |
| [Resource Notification Broker](volume-1.html#broker) | Accept the subscription request |
{: .grid}

## 3.110.3 Referenced Standards

**FHIR-R4B** [HL7 FHIR Release 4.3.0](https://www.hl7.org/FHIR/R4B)

## 3.110.4 Interactions

<figure>
{%include ITI-110-seq.svg%}
<figcaption><b>Figure 2:3.110: ITI-110 interactions</b></figcaption>
</figure>
<br clear="all">

### 3.110.5 Create Subscription Request Message
This message uses the HTTP POST method on the target Resource Notification Broker endpoint to submit the subscription resource.

#### 3.110.5.1 Trigger Events

This method is invoked when the Resource Notification Subscriber needs to submit a new subscription resource to the Resource Notification Broker. The Resource Notification Subscriber has already discovered the SubscriptionToipic resource supported by the Resource Notification Broker. (Note that the SubscriptionToipic discovery may be done with the Resource Subscription Search [[ITI-114]](ITI-114.html) (see 1:54.2.2 SubscriptionTopic Search) or by sharing these resources with different methodologies among the community.)

#### 3.110.5.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for “create” interaction [(https://hl7.org/fhir/R4B/http.html#create)](https://hl7.org/fhir/R4B/http.html#create). The message uses an HTTP POST method to submit a Subscription FHIR Resource.

The Subscription resource shall be compliant with [Subscription](https://hl7.org/fhir/R4B/Subscription.html) and shall support the [Profile: R4/B Topic-Based Subscription](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-Subscription.html#root). In this resource profile, the Subscription resource shall comply with one of the SubscriptionTopic resources implemented by the Resource Notification Broker. The `Subscription.criteria` element shall include the fullUrl that represents the SubscriptionTopic that the Subscription resource is related to. The `Subscription.criteria` element shall support the [FilterBy Criteria extension](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-filter-criteria.html#root). This extension shall be used to narrow the subscription triggering events defined in the related SubscriptionTopic resource.  

For document subscription, different types of subscription resources may be submitted to the Resource Notification Broker.

The DSUBm profile specifies the following types of subscriptions:

1. Patient Dependent Document Subscription resource:
    - shall contain in the `Subscription.criteria` element the reference to an existing SubscriptionTopic  resource with `SubscriptionTopic.resourceTrigger.resource = DocumentReference`;  
    - in the `Subscription.criteria` element shall be included a patient identifier (DocumentReference.subject);
    - in the `Subscription.criteria` element may be included any additional element of the DocumentReference in order to narrow the subscription topic defined int the subscriptionTopic resource. 
    - the status shall be `Subscription.status = requested`;
    - the channel.type element shall be `channel.type=rest-hook`.
    
2. Multi-patient Subscription resource:
    
    2.1. Multi-patient Document resource:
    - shall contain in the `Subscription.criteria` element the reference to an existing SubscriptionTopic  resource with `SubscriptionTopic.resourceTrigger.resource = DocumentReference`;  
    - in the `Subscription.criteria` element shall not be included a patient identifier (DocumentReference.subject);
    - in the `Subscription.criteria` element may be included any additional elements in order to narrow the subscription topic defined int the subscriptionTopic resource. 
    - the status shall be `Subscription.status = requested`;
    - the channel.type element shall be `channel.type=rest-hook`.


    2.2. Multi-patient SubmissionSet Subscription resource:
    - shall contain in the `Subscription.criteria` element the reference to an existing SubscriptionTopic  resource with `SubscriptionTopic.resourceTrigger.resource = SubmissionSet`;  
    - in the `Subscription.criteria` element shall not be included a patient identifier (SubmissionSet.subject);
    - in the `Subscription.criteria` element may be included any additional elements in order to narrow the subscription topic defined int the subscriptionTopic resource. 
    - the status shall be `Subscription.status = requested`;
    - the channel.type element shall be `channel.type=rest-hook`.

3. Folder Subscription:
    - shall contain in the `Subscription.criteria` element the reference to an existing SubscriptionTopic  resource with `SubscriptionTopic.resourceTrigger.resource = Folder`;  
    - a Folder identifier shall be contained in the criteria element;
    - in the `Subscription.criteria` element shall be included a patient identifier (Folder.subject);
    - the status shall be `Subscription.status = requested`;
    - the channel.type element shall be `channel.type=rest-hook`. 

4. SubmissionSet Subscription:
    - shall contain in the Subscription.criteria element the reference to an existing SubscriptionTopic  resource with `SubscriptionTopic.resourceTrigger.resource = SubmissionSet List`;
    - in the `Subscription.criteria` element shall be included the SubmissionSetList.subject element;
    - in the `Subscription.criteria` element may optionally be included: the SubmissionSetList.source element and the extension for the [sourceId](https://profiles.ihe.net/ITI/MHD/StructureDefinition/ihe-sourceId) and the extension for the [intendedRecipient](https://profiles.ihe.net/ITI/MHD/StructureDefinition/ihe-intendedRecipient);
    - the status shall be `Subscription.status = requested`;
    - the channel.type element shall be `channel.type=rest-hook`.
    

All the subscription resources should support the following extension

- [filter Criteria](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-filter-criteria.html)
- [channel type]( http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-channel-type)
- [payload content](http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-payload-content)

The Resource Notification Subscriber shall indicate in the `Subscription.payload` element the level of detail of the future notification that the Resource Notification Broker will send. The payload content extension defines three types of payload: 

- `empty` = No resource content is transmitted in the notification payload.
- `id-only` = Only the resource id is transmitted in the notification payload.
- `full-resource` = The entire resource is transmitted in the notification payload.

The Subscription resource shall have a `channel.type = "rest-hook"` and the element `channel.endpoint` shall contain the URL to which is intended to receive the notification.

<COMMENT For the profiling of these three types of subscription FHIR resources see [here][(Subscription_mapping.html)]() !!! LINK !!!>

The Resource Notification Subscriber actor shall submit the FHIR Subscription resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.

The Resource Subscription message is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol.


#### 3.110.5.3 Expected Actions

Upon receiving the request message the Resource Notification Broker shall verify the following conditions: 

- the SubscriptionTopic (referred in the `Subscription.criteria` element received in the subscription resource) is valid (`SubscriptionTopic.status="active"`) and is implemented by the Resource Notification Broker;
- all requested filters are defined in the requested topic and are implemented in the Resource Notification Broker;
- the channel-type is `Subscription.channel-type="rest-hook"`;
- the channel endpoint is valid for the channel provided (e.g., is it a valid URL of the expected type);
- the payload configuration is known and implemented by the server
- the payload configuration is valid for the channel type requested (e.g., complies with the Resource Notification Broker security policy).

The Resource Notification Broker actor may support the handshake process to verify that the endpoint included in the subscription resource is reachable. If the Resource Notification Broker actor utilizes the handshake to verify the endpoint included in the subscription resource then the Resource Notification Subscriber shall implement the Subscription Search option. 

##### 3.110.5.3.1 Expected Actions with MHDs 
If the Resource Notification Broker is grouped with MHDs actors (see Figure 1:54.6.1.1-1) or i sgrouped with , based on the outcome of the conditions above, the Resource Notification Broker shall accept or reject the subscription resource received. If all the conditions are true the Resource Notification Broker shall create a subscription resource. 

##### 3.110.5.3.2 Expected Actions with MHD grouping
If the Resource Notification Broker is grouped with XDS actors that supports the "XDS on FHIR” option (see Figure 1:54.6.3.1), based on the outcome of the conditions above, the Resource Notification Broker shall accept or reject the subscription resource received. If all the conditions are true the Resource Notification Broker shall create a subscription resource. 

##### 3.110.5.3.3 Expected Actions with DSUB grouping
From the grouping with [DSUB - Document Metadata Subscription](volume-1.html#15463-dsub---document-metadata-subscription) there two alternative grouping with DSUB actors. Based on the chosen grouping the following expected actions shall be followed. 

<a name="mapping_DSUB"> </a>

###### 3.110.5.3.3.1 Expected Actions with DSUBm as an interface for DSUB

If the Resource Notification Broker is grouped with Document Metadata Subscriber Document Metadata Notification Recipient ([see here](volume-1.html#154631-dsubm-as-an-interface-for-dsub)) based on the outcome of the conditions above, the Resource Notification Broker shall accept or reject the subscription resource received. If all the conditions are true the following mapping between DSUBm subscription resource and DSUB Subscription shall be used: 

1.  Patient Dependent Document Subscription resource shall be mapped in a ["Subscription for DocumentEntry metadata"](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.2.1) using the [MHD ComprehensiveDocumentReference - Mappings](https://profiles.ihe.net/ITI/MHD/StructureDefinition-IHE.MHD.Comprehensive.DocumentReference-mappings.html#mappings-for-xds-and-mhd-mapping-xds). 

If the subscription resource contained in the Resource Subscription [ITI-110] transaction has a `Subscription.payload = "full-resource"` the DSUB subscription shall have a ["ihe:FullDocumentEntry" Topic Expression](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.2.2). Otherwise a ["ihe:MinimalDocumentEntry" Topic Expression](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.1.2) shall be used.

2. Multi-patient Subscription resource:
    
    2.1. Multi-patient Document Subscription resource shall be mapped in a "Patient-Independent Subscriptions for Document metadata" (see 3.52.5.2.4 "Patient-Independent Subscriptions for Document metadata" in [Supplement material](https://www.ihe.net/uploadedFiles/Documents/ITI/IHE_ITI_Suppl_DSUB_Extensions.pdf)) using the [MHD ComprehensiveDocumentReference - Mappings](https://profiles.ihe.net/ITI/MHD/StructureDefinition-IHE.MHD.Comprehensive.DocumentReference-mappings.html#mappings-for-xds-and-mhd-mapping-xds). 
    If the subscription resource contained in the Resource Subscription [ITI-110] transaction has a `Subscription.payload = "full-resource"` the DSUB subscription shall have a ["ihe:FullDocumentEntry" Topic Expression](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.2.2). Otherwise a ["ihe:MinimalDocumentEntry" Topic Expression](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.1.2) shall be used.

    
    2.2. Multi-patient SubmissionSet Subscription resource shall be mapped in a "Patient-Independent Subscriptions for SubmissionSet metadata" (see 3.52.5.2.5 "Patient-Independent Subscriptions for SubmissionSet metadata" in [Supplement material](https://www.ihe.net/uploadedFiles/Documents/ITI/IHE_ITI_Suppl_DSUB_Extensions.pdf)) using the [MHD SubmissionSetComprehensive - Mappings](https://profiles.ihe.net/ITI/MHD/StructureDefinition-IHE.MHD.Comprehensive.SubmissionSet-mappings.html#mappings-for-xds-and-mhd-mapping-xds). The Topic Expression used shall be "ihe:SubmissionSetMetadata" without considering the `Subscription.payload` contained in the Subscription resource received in the Resource Subscription [ITI-110] transaction. 
    

3. Folder Subscription resource shall be mapped in a "Subscriptions for folders metadata"(see 3.52.5.2.3 "Subscriptions for folders metadata" in [Supplement material](https://www.ihe.net/uploadedFiles/Documents/ITI/IHE_ITI_Suppl_DSUB_Extensions.pdf)) using the [MHD FolderComprehensive - Mappings](https://profiles.ihe.net/ITI/MHD/StructureDefinition-IHE.MHD.Comprehensive.Folder-mappings.html#mappings-for-xds-and-mhd-mapping-xds). 

4. SubmissionSet Subscription reource shall be mapped in a ["Subscription for SubmissionSet metadata"](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.2.2) using the [MHD SubmissionSetComprehensive - Mappings](https://profiles.ihe.net/ITI/MHD/StructureDefinition-IHE.MHD.Comprehensive.SubmissionSet-mappings.html#mappings-for-xds-and-mhd-mapping-xds). 
The Topic Expression used shall be "ihe:SubmissionSetMetadata" without considering the `Subscription.payload` contained in the Subscription resource received in the Resource Subscription [ITI-110] transaction. 

###### 3.110.5.3.3.2 Expected Actions with DSUBm as an interface for DSUB
If the Resource Notification Broker is grouped with Document Metadata Notification Broker in a "Notification Manager" ([see here](volume-1.html#154632-notification-manager)). In this configuration the subscription cretaed may be shared among DSUB and DUSBm broker actors. Based on the outcome of the conditions above, the Resource Notification Broker shall accept or reject the subscription resource received. If all the conditions are true, and, if the subscription are shared, the mapping between DSUBm subscription resource and DSUB Subscription shall follow the mapping introduced [previously](#mapping_DSUB) 

### 3.110.6 Create Subscription Response Message

The Resource Notification Broker sends a Resource Subscription Response message to respond to a Resource Subscription Request message.  

#### 3.110.6.1 Trigger Events

When the Resource Notification Broker has finished creating or rejecting the subscription resource received, the Resource Notification Broker sends this message to the Resource Notification Subscriber acknowledging the result of the creation of the resource. 

#### 3.110.6.2 Message Semantics
When the Resource Notification Broker has processed the request, it shall return an HTTP response with an overall status code.

The Resource Notification Broker returns an HTTP status code appropriate to the processing of the create request.

If the subscription has been created the Resource Notification Broker shall respond with an `HTTP 201 Created`  status code as indicated in [https://hl7.org/fhir/R4B/http.html#create](https://hl7.org/fhir/R4B/http.html#create). Otherwise, if the creation of resource has been rejected the Resource Notification Broker shall respond with `HTTP 400 Bad Request`.  

#### 3.110.6.3 Expected Actions

The Resource Notification Subscriber processes the response according to application-defined rules.


### 3.110.7 Update Subscription Request Message
This message uses the HTTP PUT method on the target Resource Notification Broker endpoint to update an existing subscription resource. The unsubscribe is a particular type of update (`Subscription.status=off`).

#### 3.110.7.1 Trigger Events

This method is invoked when the Resource Notification Subscriber needs to update an already existing subscription resource on a Resource Notification Broker.

#### 3.110.7.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for update interaction [(https://hl7.org/fhir/R4B/http.html#update)](https://hl7.org/fhir/R4B/http.html#create). The message uses an HTTP POST method to submit a Subscription FHIR Resource as defined in section 3.110.5.2.

The Resource Notification Subscriber actor shall submit the FHIR Subscription resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.

The Resource Subscription message is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol.

#### 3.110.7.3 Expected Actions

Upon receiving the request message the Resource Notification Broker shall verify the following conditions: 

- that the Subscription resource to be updated exists. (Prevent Update as Create).
- that the SubscriptionTopic (referred in the new `Subscription.criteria` element received in the subscription resource) is valid and implemented by the Resource Notification Broker;
- that all new requested filters are defined in the requested topic and are implemented in the Resource Notification Broker;
- that the new `channel-type = rest-hook`;
- that the new channel endpoint is valid for the channel provided (e.g., is it a valid URL of the expected type);
- that the new payload configuration is known and implemented by the server
- that the new payload configuration is valid for the channel type requested (e.g., complies with the Resource Notification Broker security policy).

Based on the outcome of these conditions the Resource Notification Broker shall accept/reject the update of the Subscription resource received. If all the conditions are true the Resource Notification Broker shall update the Subscription resource.
If the Resource Notification Broker is grouped with DSUB actors the mappi


### 3.110.8 Update Subscription Response Message

The Resource Notification Broker sends a Resource Subscription Response message to respond to an Update Resource Subscription Request message.  

#### 3.110.8.1 Trigger Events

When the Resource Notification Broker has finished updating or rejecting the received new version of the subscription resource, the Resource Notification Broker sends this message to the Resource Notification Subscriber acknowledging the result of the update of the resource. 

#### 3.110.8.2 Message Semantics
When the Resource Notification Broker has processed the request, it shall return an HTTP response with an overall status code.

The Resource Notification Broker returns an HTTP status code appropriate to the processing of the create request.

If the subscription has been created the Resource Notification Broker shall respond with an `HTTP 201 Created`  status code as indicated in [https://hl7.org/fhir/R4B/http.html#create](https://hl7.org/fhir/R4B/http.html#create).Otherwise, if the creation of resource has been rejected the Resource Notification Broker shall respond with `HTTP 400 Bad Request`.  


#### 3.110.8.3 Expected Actions

The Resource Notification Subscriber processes the response according to application-defined rules.

## CapabilityStatement Resource

The Server implementing this transaction shall provide a CapabilityStatement Resource as described in ITI TF-2x: Appendix Z.3 indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [Client](CapabilityStatement-IHE.ToDo.client.html)
* Requirements CapabilityStatement for [Server](CapabilityStatement-IHE.ToDo.server.html)

## Security Considerations 
See [DSUBm Security Considerations](volume-1.html#security-considerations). 

The Resource Notification Broker may control that the Resource Notification Subscriber is acceptable and authorised to create/update a Subscription Resource. 
The Resource Notification Broker may also be aware and enforce any agreed policy in order to control that the subscription criteria received, that describe the notification event, are permitted to the Resource Notification Subscriber. 

The Resource Notification Broker might maintain a whitelist of acceptable senders for the rest-create/rest-update methods. 
The Resource Notification Broker may enforce some control on `channel.endpoint` element of Subscription resource received in order to control where the notification will be sent. The Resource Notification Broker might maintain a allow-list of acceptable endpoints or trusted certificate authorities for rest-hook channels.
The Resource Notification Broker may control the `Subscription.payload` element of Subscription resource received in order to mitigate the risk of disclosing sensitive information. For example, if the Subscription criteria includes sensitive documents, the Resource Notification Broker may allow just 'id-only' payloads. In this way further authorization mechanism shall be enforced when the Resource Notification Recipient tries to recover the information using the id. 

### Security Audit Considerations

''TODO: The security audit criteria ''

##### Client Audit 

''TODO: the specifics''

#### Server Audit 

''TODO: the specifics''
