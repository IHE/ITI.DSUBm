This section corresponds to the Resource Subscription [ITI-110] transaction of the IHE Technical Framework. The Resource Subscription [ITI-110] transaction is used by the Resource Notification Subscriber and Resource Notification Broker actors to submit a subscription in order to receive a notification.

### 2:3.110.1 Scope

The Resource Subscription [ITI-110] transaction passes a Resource Subscription Request from a Resource Notification Subscriber to a Resource Notification Broker. This transaction can be used to **create a new Subscription** or to **update an existing Subscription**. The update of the subscription is intended to be used only to **unsubscribe (deactivate)** to an existing Subscription or **re-activate** an already existing Subscription (in case of errors or deactivation). 

### 2:3.110.2 Actors Roles

**Table 2:3.110.2-1: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Subscriber](volume-1.html#154112-resource-notification-subscriber)    | Sends the Subscription request to the Resource Notification Broker |
| [Resource Notification Broker](volume-1.html#154111-resource-notification-broker) | Receives and processes the Subscription request |
{: .grid}

### 2:3.110.3 Referenced Standards

**FHIR-R4B** [HL7 FHIR Release 4.3.0](https://www.hl7.org/FHIR/R4B)

### 2:3.110.4 Interactions

<figure>
{%include ITI-110-seq.svg%}
<figcaption><b>Figure 2:3.110.4-1: Resource Subscription [ITI-110] interactions</b></figcaption>
</figure>
<br clear="all">

### 2:3.110.5 Create Subscription Request Message
This message uses the HTTP POST method on the target Resource Notification Broker endpoint to submit the Subscription resource.

#### 2:3.110.5.1 Trigger Events

This method is invoked when the Resource Notification Subscriber needs to submit a new subscription resource to the Resource Notification Broker. The Resource Notification Subscriber shall have already discovered the SubscriptionTopics supported by the Resource Notification Broker in order to create a subscription. The discovery should be performed by the [Resource SubscriptionTopic Search [ITI-114]](ITI-114.html) transaction or may be performed by any other methods that are out of the scope of this profile.

#### 2:3.110.5.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to the requirements defined in the HL7® FHIR® standard for the "[create](https://hl7.org/fhir/R4B/http.html#create)" interaction. The message uses an HTTP POST method to submit a Subscription FHIR Resource as specified in [3.110.5.2.1 Subscription Resource paragraph](#23110521-subscription-resource).

The Resource Notification Subscriber actor shall submit the FHIR Subscription resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.

The Subscription is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) for the definition of "HTTP" access methods and "base."

It is possible to use HTTP protocol or HTTPS protocol. The HTTPS protocol is highly recommended.

##### 2:3.110.5.2.1 Subscription Resource

The Subscription resource shall be compliant with the [Subscription](https://hl7.org/fhir/R4B/Subscription.html) resource and shall be compliant with the [Profile: R4/B Topic-Based Subscription](http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-subscription). 

The `Subscription.criteria` element shall include the canonical URL to a SubscriptionTopic resource that represents the Topic that the Subscription resource is related to. The `Subscription.criteria` element shall support the [FilterBy Criteria extension](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-filter-criteria.html#root). This extension shall be used to narrow the subscription triggering events defined in the related SubscriptionTopic resource.  

All the Subscription resources shall support the following extensions:

- [channel type]( http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-channel-type)
- [payload content](http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-payload-content)

The Resource Notification Subscriber shall indicate in the `Subscription.payload.content` element the level of detail of the future notification that the Resource Notification Broker will send. The payload content extension defines three types of payload: 

- `empty` = No resource content is transmitted in the notification payload.
- `id-only` = Only the resource id is transmitted in the notification payload.
- `full-resource` = The entire resource is transmitted in the notification payload.

All the Subscription resources shall have `Subscription.status="requested"`, `channel.type = "rest-hook"`, and `channel.endpoint` shall contain the URL that identifies where the Resource Notification Recipient receives the notification.

All the Subscription resources may have `Subscription.end` element set, indicating the instant when the subscription automatically terminates.

For documents, different types of subscription resources may be submitted to the Resource Notification Broker.

This profile defines the following types of Subscriptions with related SubscriptionTopic, which the Resource Notification Broker shall support and at least one of them the Resource Notification Subscriber shall support:

  | Subscription type | SubscriptionTopic |
  |-------------------+----------------|
  | [Patient-Dependent DocumentReference Subscriptions](StructureDefinition-DSUBm-DocumentReference-PatientDependent-Subscription.html)  |[Patient-Dependent DocumentReference SubscriptionTopic](#2311091-patient-dependent-documentreference-subscription-topic) |
  | [Multi-Patient DocumentReference Subscriptions](StructureDefinition-DSUBm-DocumentReference-MultiPatient-Subscription.html) |[Multi-Patient DocumentReference SubscriptionsTopic](#2311092-multi-patient-documentreference-subscriptions-topic)|
  | [Patient-Dependent SubmissionSet Subscriptions](StructureDefinition-DSUBm-SubmissionSet-PatientDependent-Subscription.html)  | [Patient-Dependent SubmissionSet SubscriptionTopic](#2311093-patient-dependent-submissionset-subscription-topic) |
  | [Multi-Patient SubmissionSet Subscriptions](StructureDefinition-DSUBm-SubmissionSet-MultiPatient-Subscription.html) |[Multi-Patient SubmissionSet SubscriptionTopic](#2311094-multi-patient-submissionset-subscription-topic) |
  {: .grid}

###### 2:3.110.5.2.1.1 Subscription with DocumentReference Subscription for Minimal Update option

When supporting the DocumentReference Subscription for Minimal Update option, this profile also defines the following types of Subscriptions with related SubscriptionTopic:

  | Subscription type | SubscriptionTopic |
  |-------------------+----------------|
  | [Patient-Dependent DocumentReference Subscriptions with DocumentReference Subscription for Minimal Update option](StructureDefinition-DSUBm-DocumentReference-PatientDependent-Subscription-MinUpdate.html)  |[Patient-Dependent DocumentReference SubscriptionTopic with DocumentReference Subscription for Minimal Update option](#23110911-patient-dependent-documentreference-subscription-subscription-with-documentreference-subscription-for-minimal-update-option-topic) |
  | [Multi-Patient DocumentReference Subscription DocumentReference Subscription for Minimal Update option](StructureDefinition-DSUBm-DocumentReference-MultiPatient-Subscription-MinUpdate.html) |[Multi-Patient DocumentReference SubscriptionTopic with DocumentReference Subscription for Minimal Update option](#23110921-multi-patient-documentreference-subscription-subscription-with-documentreference-subscription-for-minimal-update-option-topic)|
  {: .grid}


###### 2:3.110.5.2.1.2 Subscription with DocumentReference Subscription for Full Events option

When supporting the DocumentReference Subscription for Full Events option, this profile also defines the following types of Subscriptions with related SubscriptionTopic:

  | Subscription type | SubscriptionTopic |
  |-------------------+----------------|
  | [Patient-Dependent DocumentReference Subscriptions with DocumentReference Subscription for Full Events option](StructureDefinition-DSUBm-DocumentReference-PatientDependent-Subscription-AllEvents.html)  |[Patient-Dependent DocumentReference SubscriptionTopic with DocumentReference Subscription for Full Events option](#23110912-patient-dependent-documentreference-subscription-subscription-with-documentreference-subscription-for-full-events-option-topic) |
  | [Multi-Patient DocumentReference Subscription with DocumentReference Subscription for Full Events option](StructureDefinition-DSUBm-DocumentReference-MultiPatient-Subscription-AllEvents.html) |[Multi-Patient DocumentReference SubscriptionTopic with DocumentReference Subscription for Full Events option](#23110922-multi-patient-documentreference-subscription-subscription-with-documentreference-subscription-for-full-events-option-topic)|
  {: .grid}


###### 2:3.110.5.2.1.3 Subscription with Basic Folder Subscription option

When supporting the Basic Folder Subscription option, this profile also defines the following types of Subscriptions with related SubscriptionTopic:
  | Subscription type | SubscriptionTopic |
  |-------------------+----------------|
  | [Basic Folder Subscriptions](StructureDefinition-DSUBm-Basic-Folder-Subscription.html) |[Basic Folder SubscriptionTopic](#2311095-basic-folder-subscription-topic) |
  {: .grid}

###### 2:3.110.5.2.1.4 Subscription with Folder Subscription for Minimal Update option

When supporting the Folder Subscription for Minimal Update option, this profile also defines the following types of Subscriptions with related SubscriptionTopic:
  | Subscription type | SubscriptionTopic |
  |-------------------+----------------|  
  | [Folder Subscriptions with Folder Subscription for Minimal Update option](StructureDefinition-DSUBm-Folder-Subscription-MinUpdateOpt.html) |[Folder SubscriptionTopic with Folder Subscription for Minimal Update option](#23110951-folder-subscription-with-folder-subscription-for-minimal-update-option-topic) |
  {: .grid}

###### 2:3.110.5.2.1.5 Subscription with Folder Subscription for Update option

When supporting the Folder Subscription for Update option, this profile also defines the following types of Subscriptions with related SubscriptionTopic:
  | Subscription type | SubscriptionTopic |
  |-------------------+----------------|
  | [Folder Subscriptions with Folder Subscription for Update option](StructureDefinition-DSUBm-Folder-Subscription-UpdateOpt.html) |[Folder SubscriptionTopic with Folder Subscription for Update option](#23110952-folder-subscription-with-folder-subscription-for-update-option-topic) |
  {: .grid}

###### 2:3.110.5.2.1.6 Subscription with Folder Subscription for Full Events option

When supporting the Folder Subscription for Full Events option, this profile also defines the following types of Subscriptions with related SubscriptionTopic:
  | Subscription type | SubscriptionTopic |
  |-------------------+----------------|
  | [Folder Subscriptions with Folder Subscription for Full Events option](StructureDefinition-DSUBm-Folder-Subscription-for-Full-Events.html) |[Folder SubscriptionTopic with Folder Subscription for Full Events option](#23110953-folder-subscription-with-folder-subscription-for-full-events-option-topic) |
  {: .grid}

#### 2:3.110.5.3 Expected Actions

Upon receiving the request message the Resource Notification Broker shall verify the following conditions: 

- the SubscriptionTopic (referred in the `Subscription.criteria` element received in the Subscription resource) is valid;
- all requested filters are defined in the requested topic;
- the channel-type is `rest-hook`;
- the channel endpoint is valid for the channel provided (e.g., it is a valid URL of the expected type);
- the payload configuration is known and implemented by the server;
- the payload configuration is valid for the channel type requested (e.g., complies with the Resource Notification Broker security policy);
- the termination time (`Subscription.end`), if present, express a valid timestamp in the future.

The Resource Notification Broker actor shall support the handshake process to verify that the endpoint that identifies the Resource Notification Recipient, in the `Subscription.channel.endpoint` element of the subscription resource, is reachable before activating the subscription.
The Resource Notification Broker shall set initial status to `requested`, pending verification of the nominated endpoint URL. In this case the Resource Notification Broker shall send to the Resource Notification Recipient a [Handshake Notification Message [ITI-112]](ITI-112.html#231125-handshake-notification-request-message). After a successful handshake notification has been sent and accepted, the Resource Notification Broker shall update the status to `active`. Any errors in the initial handshake shall result in the status being changed to `error`. Note that the Resource Notification Subscriber should implement the [Subscription Search [ITI-113]](ITI-113.html) transaction in order to verify the activation of the subscription. 

The Resource Notification Broker shall enforce all the [Security Considerations.](#2311012-security-considerations)

The Resource Notification Broker may opt to not duplicate a Subscription on the basis of the information transmitted in the request message (e.g. criteria, endpoint, user authentication, etc.) in order to prevent multiple Subscriptions and Notifications.

Based on the outcome of the conditions above the Resource Notification Broker shall accept or reject the subscription resource received. If all the conditions are true the Resource Notification Broker shall create a Subscription resource and activate the subscription.

When the Subscription Resource uses the `heartbeatPeriod`, if accepted, the Resource Notification Broker should send one [Heartbeat Notification Message [ITI-112]](ITI-112.html#231127-heartbeat-notification-request-message) per interval on the accepted and active subscription.

Once the Subscription is activated, the Resource Notification Broker shall monitor resources based on the Subscription criteria and, if matches, shall send the appropriate Resource Notification Recipient a [Event Notification Message [ITI-112]](ITI-112.html#231129-event-notification-request-message).

Further considerations needs to be done, for the activation of a Subscription, considering DSUBm as an interface for a DSUB environment.

##### 2:3.110.5.3.1 Expected Actions with DSUBm as an interface for DSUB

If the Resource Notification Broker is grouped with DSUB Document Metadata Subscriber and DSUB Document Metadata Notification Recipient, considering [DSUBm as an interface for DSUB](volume-1.html#15463-dsubm-as-an-interface-for-dsub) model, if the subscription is accepted, the Resource Notification Broker shall trigger a [Subscribe Request message](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.4.2) towards the DSUB Document Metadata Notification Broker from the DSUB Document Metadata Subscriber with an Document Metadata Subscribe [ITI-52] transaction.

The mapping between the Subscription resource contained in the Resource Subscription [ITI-110] transaction and the Document Metadata Subscribe [ITI-52] transaction shall be as following:

- If the Subscription resource has a `Subscription.payload = "full-resource"` the Document Metadata Subscribe [ITI-52]  transaction shall have a ["ihe:FullDocumentEntry" Topic Expression](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.2.2). Otherwise a ["ihe:MinimalDocumentEntry" Topic Expression](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.1.2) shall be used.

- Depending on the type of the Subscription, the AdHocQuery/@id attribute and the the Filters parameter of the Document Metadata Subscribe [ITI-52] transaction shall be set as follows:

  | Subscription type | AdHocQuery/@id | Filter parameter |
  |-------------------+--------------+------------|
  | Patient-Dependent DocumentReference Subscriptions  | `urn:uuid:aa2332d0-f8fe-11e0-be50-0800200c9a66` | Mapping based on [Table 3:110.9-1](#table-docRef) |
  | Multi-Patient DocumentReference Subscriptions | `urn:uuid:742790e0-aba6-43d6-9f1fe43ed9790b79` | Mapping based on [Table 3:110.9-1](#table-docRef) |
  | Patient-Dependent SubmissionSet Subscriptions  | `urn:uuid:fbede94e-dbdc-4f6b-bc1f-d730e677cece`| Mapping based on [Table 3:110.9-2](#table-submiss)|
  | Multi-Patient SubmissionSet Subscriptions| `urn:uuid:868cad3d-ec09-4565-b66c-1be10d034399`|Mapping based on [Table 3:110.9-2](#table-submiss) |
  | Basic Folder Subscriptions | `urn:uuid:9376254e-da05-41f5-9af3-ac56d63d8ebd`|Mapping based on [Table 3:110.9-3](#table-folder) |
  {: .grid}

- If the Subscription resource has the `Subscription.end` element set, the Document Metadata Subscribe [ITI-52] transaction shall have a `wsnt:InitialTerminationTime` element set.

When the Document Metadata Subscribe [ITI-52] transaction has a successful result, the Resource Notification Broker shall maintain the coupling between the Subscription Resource id and the webservice endpoint present in the `Address` element of the Document Metadata Subscribe [ITI-52] response message, in order to be capable of managing a later unsubscription.

If the DSUB Document Metadata Notification Broker sends an assigned duration for the subscription, the Resource Notification Broker shall associate the assigned duration with the accepted subscription request end eventually unsubscribe towards the DSUB Document Metadata Notification Broker when expired.

### 2:3.110.6 Create Subscription Response Message

The Resource Notification Broker sends a Resource Subscription Response Message to respond to a Create Subscription Request Message.  

#### 2:3.110.6.1 Trigger Events

When the Resource Notification Broker has finished evaluating the subscription received and the operation, the Resource Notification Broker sends this message to the Resource Notification Subscriber acknowledging the result of the creation of the resource. 

#### 2:3.110.6.2 Message Semantics
When the Resource Notification Broker has processed the request, it shall return an HTTP response with an overall status code.

The Resource Notification Broker shall returns an HTTP status code appropriate to the request and the operation.

If the Subscription has been created, the Resource Notification Broker shall respond with an `HTTP 201 Created` status code as indicated for "[create](https://hl7.org/fhir/R4B/http.html#create)" and the Resource Notification Broker shall return the entire resource in which the status shall be `requested`. If the Resource Notification Broker has assigned a termination time, the element `end` shall be valued.

If the interaction failed, common HTTP Status codes returned on FHIR-related errors (in addition to normal HTTP errors related to security, header and content type negotiation issues) are:
- `400 Bad Request` - resource could not be parsed or failed basic FHIR validation rules (or multiple matches were found for conditional criteria)
- `401 Not Authorized` - authorization is required for the interaction that was attempted
- `404 Not Found` - resource type not supported, or not a FHIR end-point
- `405 Method Not allowed` - the resource did not exist prior to the update, and the server does not allow client defined ids
- `422 Unprocessable Entity` - the proposed resource violated applicable FHIR profiles or server business rules
Those should be accompanied by an [OperationOutcome](https://hl7.org/fhir/R4B/operationoutcome.html) resource providing additional detail.

The Resource Notification Broker can return other status codes 4xx or 5xx in accordance to internal business rules that are out of scope for this transaction.

#### 2:3.110.6.3 Expected Actions

The Resource Notification Subscriber processes the response according to application-defined rules.

For the Subscription creation:

  - If the Resource Notification Subscriber had not indicated a requested duration for the subscription, the Resource Notification Broker may send an assigned duration for the subscription (if any), using the `Subscription.end` element.

  - If the Resource Notification Broker sends an assigned duration for the subscription, the Resource Notification Subscriber shall associate the assigned duration with the accepted subscription request.

  - The Resource Notification Subscriber shall associate the accepted subscription request with the subscription id assigned by the Resource Notification Broker in order to be able to send cancellations for existing subscriptions.

### 2:3.110.7 Update Subscription Request Message
This message uses the HTTP PUT method on the target Resource Notification Broker endpoint to update an existing Subscription resource in order to:
- unsubscribe, or
- re-activate it.

#### 2:3.110.7.1 Trigger Events

This method is invoked when the Resource Notification Subscriber needs to:
- unsubscribe for an already existing subscription
- re-activate an already existing subscription

so it sends an update of the Subscription resource to the Resource Notification Broker.

#### 2:3.110.7.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for "[update](https://hl7.org/fhir/R4B/http.html#update)" interaction. The message uses an HTTP PUT method to update a Subscription FHIR Resource previously created (see section [2:3.110.5 Create Subscription Request Message](#231105-create-subscription-request-message)). 

The `Subscription.id` element shall be valued with the id of the Subscription to be updated.
 
In order to unsubscribe, the Subscription Resource shall have `status=off`.

In order to re-activate an already existing Subscription, the Subscription Resource shall have `status=requested`.

The Resource Notification Subscriber actor shall submit the FHIR Subscription resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.

The Resource Subscription message is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol. The HTTPS protocol is highly recommended.

#### 2:3.110.7.3 Expected Actions

Upon receiving the request message the Resource Notification Broker shall verify the following conditions: 

- that the Subscription resource to be updated exists (Prevent Update as Create);
- the Subscription.status sended is `off` or the Subscription.status sended is `requested` and the actual Subscription.status is `error` or `off`. 

The Resource Notification Broker shall enforce all the [Security Considerations](#2311012-security-considerations).

Based on the outcome of the conditions above the Resource Notification Broker shall accept or reject the update of the subscription resource received. If all the conditions are true the Resource Notification Broker shall:
- in case of unsubscribe, update the Subscription resource and deactivate the subscription (`status=off`). When deactivated, the Resource Notification Broker should sent a [Subscription Deactivation Notification [ITI-112]](ITI-112.html#2311211-subscription-deactivation-notification-request-message) to the Resource Notification Recipient. No other notification shall be sent.
- in case of re-activation of an already existing subscription, follow the Expected Actions which are reported in Section [2:3.110.5.3 Expected Actions](#2311053-expected-actions).

Further considerations needs to be done in the following paragraph, considering DSUBm as an interface for DSUB environment.

##### 2:3.110.7.3.1 Expected Actions with DSUBm as an interface for DSUB for unsubscription

If the Resource Notification Broker is grouped with DSUB Document Metadata Subscriber and DSUB Document Metadata Notification Recipient, considering [DSUBm as an interface for DSUB](volume-1.html#15463-dsubm-as-an-interface-for-dsub) model, if the update of the subscription is accepted, the Resource Notification Broker shall trigger the Document Metadata Subscriber to send an [Unsubscribe Request message](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.4.3) towards the Document Metadata Notification Broker with an [ITI-52] Document Metadata Subscribe transaction. The message shall be sent to the webservice endpoint previously associated to the Subscription id (see section [2:3.110.5.3.1 Expected Actions](#23110531-expected-actions-with-dsubm-as-an-interface-for-dsub) section). 

##### 2:3.110.7.3.2 Expected Actions with DSUBm as an interface for DSUB for re-activation

If the Resource Notification Broker is grouped with DSUB Document Metadata Subscriber and DSUB Document Metadata Notification Recipient, considering [DSUBm as an interface for DSUB](volume-1.html#15463-dsubm-as-an-interface-for-dsub) model, when the update is for re-activate errored Subscription (Subscription.status sended is `requested` and the actual Subscription.status is `error`) this grouping does not require further Expected Actions.

Instead, for this grouping, when the update is for re-activate turned off Subscription (Subscription.status sended is `requested` and the actual Subscription.status is `off`) the Resource Notification Broker shall consider the re-activation like a new Subscription that shall be propagated to the DSUB Document Metadata Notification Broker. So, the Resource Notification Broker shall trigger a [Subscribe Request message](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.4.2) towards the DSUB Document Metadata Notification Broker from the DSUB Document Metadata Subscriber with an Document Metadata Subscribe [ITI-52] transaction, following what is defined in Section [Expected Actions with DSUBm as an interface for DSUB](#23110531-expected-actions-with-dsubm-as-an-interface-for-dsub). 

### 2:3.110.8 Update Subscription Response Message

The Resource Notification Broker sends a Resource Subscription Response Message to respond to an Update Subscription Request Message.  

#### 2:3.110.8.1 Trigger Events

When the Resource Notification Broker has finished evaluating the subscription received and the operation, the Resource Notification Broker sends this message to the Resource Notification Subscriber acknowledging the result the update of the resource. 

#### 2:3.110.8.2 Message Semantics
When the Resource Notification Broker has processed the request, it shall return an HTTP response with an overall status code.

The Resource Notification Broker shall returns an HTTP status code appropriate to the request and the operation.

If the Subscription has been updated, the Resource Notification Broker shall respond with an `HTTP 200 OK` status code as indicated for "[update](https://hl7.org/fhir/R4B/http.html#update)" and the Resource Notification Broker shall return the entire resource in which the status shall be `off` for subscription deactivation or `requested` for subscription re-activation from error.

If the interaction failed, common HTTP Status codes returned on FHIR-related errors (in addition to normal HTTP errors related to security, header and content type negotiation issues) are:
- `400 Bad Request` - resource could not be parsed or failed basic FHIR validation rules (or multiple matches were found for conditional criteria)
- `401 Not Authorized` - authorization is required for the interaction that was attempted
- `404 Not Found` - resource type not supported, or not a FHIR end-point
- `405 Method Not allowed` - the resource did not exist prior to the update, and the server does not allow client defined ids
- `422 Unprocessable Entity` - the proposed resource violated applicable FHIR profiles or server business rules
Those should be accompanied by an [OperationOutcome](https://hl7.org/fhir/R4B/operationoutcome.html) resource providing additional detail.

The Resource Notification Broker can return other status codes 4xx or 5xx in accordance to internal business rules that are out of scope for this transaction.

#### 2:3.110.8.3 Expected Actions

The Resource Notification Subscriber processes the response according to application-defined rules.

### 2:3.110.9 Subscription Topic and Filter Expressions

This section clarifies the Subscription Topics and the filter parameters for each type of Subscription that this profile defines. 

Further, for each type of subscription, the events for which subscriptions are possible are specified that the Resource Notification Broker shall evaluate. The Resource Notification Broker becomes aware of such events either via a Resource Publish [ITI-111] transaction, or via other mechanisms not specified by this profile.

<a name="Patient-Dependent DocumentReference Subscription Topic"> </a>

#### 2:3.110.9.1 Patient-Dependent DocumentReference Subscription Topic

For this type of subscription, the stream of events for which subscriptions are possible is limited to events representing the **creation** of DocumentReference Resources related to Documents. Note that these events could be determined by Document Entry Objects creation in XDS environment. Note that these creation events could be happened with other events.

For this type of subscription, the possible subscription filter parameters are:

- `author.given` and `author.family`
- `category`
- `event`
- `facility`
- `format`
- `patient`
- `patient.identifier`
- `security-label`
- `setting`
- `type`
- `status`

For the definition of these parameters see [ITI-67 Query Search Parameters](https://profiles.ihe.net/ITI/MHD/ITI-67.html#23674121-query-search-parameters).

At least one of the patient or patient.identifier parameters shall be used.

With the exception of status and patient or patient.identifier, all parameters may be multi-valued.

The canonical URL of this SubscriptionTopic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-DocumentReference-PatientDependent`.

The Resource Notification Broker shall support all the filter parameter that are expressed in the SubscriptionTopic. The Resource Notification Broker shall determine if there is a Subscription which matches any of the DocumentReference resources in an event. The evaluation performed is likely a search operation using the criteria in the Subscription. If it matches, the Resource Notification Broker shall send an [Event Notification Message [ITI-112]](ITI-112.html#231129-event-notification-request-message). If the `Subscription.payload.content` includes resources, the DocumentReference resources shall be present.

The canonical instance of this SubscriptionTopic is reported here: [Patient-Dependent DocumentReference SubscriptionTopic](SubscriptionTopic-DSUBm-SubscriptionTopic-DocumentReference-PatientDependent.html).

##### 2:3.110.9.1.1 Patient-Dependent DocumentReference Subscription Subscription with DocumentReference Subscription for Minimal Update option Topic

When supporting the [DocumentReference Subscription for Minimal Update option](volume-1.html#15421-documentreference-subscription-for-minimal-update-option), this Subscription Topic extends the [Patient-Dependent DocumentReference SubscriptionTopic](#2311091-patient-dependent-documentreference-subscription-topic) in this way:

- the stream of events for which subscriptions are possible also **includes** events representing **only the update of the "status" and the deletion** of DocumentReference Resources related to Documents. Note that these events could be determined by Document Entry Objects updated or deleted in an XDS environment.

The canonical URL of this SubscriptionTopic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-DocReference-PatientDependent-MinUpdate`.

The canonical instance of this SubscriptionTopic is reported here: [Patient-Dependent DocumentReference SubscriptionTopic with DocumentReference Subscription for Minimal Update option](SubscriptionTopic-DSUBm-SubscriptionTopic-DocReference-PatientDependent-MinUpdate.html).

##### 2:3.110.9.1.2 Patient-Dependent DocumentReference Subscription Subscription with DocumentReference Subscription for Full Events option Topic

When supporting the [DocumentReference Subscription for Full Events option](volume-1.html#15422-documentreference-subscription-for-full-events-option), this Subscription Topic extends the [Patient-Dependent DocumentReference SubscriptionTopic](#2311091-patient-dependent-documentreference-subscription-topic) in this way:

- the stream of events for which subscriptions are possible also **includes** events representing **the update and the deletion** of DocumentReference Resources related to Documents. Note that these events could be determined by Document Entry Objects updated or deleted in an XDS environment.

The canonical URL of this SubscriptionTopic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-DocReference-PatientDependent-AllEvents`.

The canonical instance of this SubscriptionTopic is reported here: [Patient-Dependent DocumentReference SubscriptionTopic with Updates to document sharing resources option](SubscriptionTopic-DSUBm-SubscriptionTopic-DocReference-PatientDependent-AllEvents.html).

#### 2:3.110.9.2 Multi-Patient DocumentReference Subscriptions Topic

For this type of subscription, the stream of events for which subscriptions are possible is limited to events representing the **creation** of DocumentReference Resources related to Documents. Note that these events could be determined from Document Entry Objects created in an XDS environment. Note that these creation events could happen with other events.

For this type of subscription, the possible subscription filter parameters are:

- `author.given` and `author.family`
- `category`
- `event`
- `facility`
- `format`
- `security-label`
- `setting`
- `type`
- `status`

For the definition of these parameters see [ITI-67 Query Search Parameters](https://profiles.ihe.net/ITI/MHD/ITI-67.html#23674121-query-search-parameters).

With the exception of status, all parameters may be multi-valued.

The canonical URL of this SubscriptionTopic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-DocumentReference-MultiPatient`.

The Resource Notification Broker shall support all the filter parameter that are expressed in the SubscriptionTopic. The Resource Notification Broker shall determine if there is a Subscription which matches any of the DocumentReference resources in an event. The evaluation performed is likely a search operation using the criteria in the Subscription. If it matches, the Resource Notification Broker shall send a [Event Notification Message [ITI-112]](ITI-112.html#231129-event-notification-request-message). If the `Subscription.payload.content` includes resources, the DocumentReference resources shall be present.

The canonical instance of this SubscriptionTopic is reported here: [Multi-Patient DocumentReference SubscriptionTopic](SubscriptionTopic-DSUBm-SubscriptionTopic-DocumentReference-MultiPatient.html).


##### 2:3.110.9.2.1 Multi-Patient DocumentReference Subscription Subscription with DocumentReference Subscription for Minimal Update option Topic

When the [DocumentReference Subscription for Minimal Update option](volume-1.html#15421-documentreference-subscription-for-minimal-update-option) is supported, the following Subscription Topic extends the [Multi-Patient DocumentReference Subscriptions Topic](#2311092-multi-patient-documentreference-subscriptions-topic) in this way:

- the stream of events for which subscriptions are possible also **includes** events representing **only the update of the "status" and the deletion** of DocumentReference Resources related to Documents. Note that these events could be determined by Document Entry Objects updated or deleted in an XDS environment.

The canonical URL of this SubscriptionTopic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-DocReference-MultiPatient-MinUpdate`.

The canonical instance of this extended SubscriptionTopic is reported here: [Multi-Patient DocumentReference SubscriptionTopic with DocumentReference Subscription for Minimal Update option](SubscriptionTopic-DSUBm-SubscriptionTopic-DocReference-MultiPatient-MinUpdate.html).

##### 2:3.110.9.2.2 Multi-Patient DocumentReference Subscription Subscription with DocumentReference Subscription for Full Events option Topic

When the [DocumentReference Subscription for Full Events option](volume-1.html#15422-documentreference-subscription-for-full-events-option) is supported, the following Subscription Topic extends the [Multi-Patient DocumentReference Subscriptions Topic](#2311092-multi-patient-documentreference-subscriptions-topic) in this way:

- the stream of events for which subscriptions are possible also **includes** events representing **the update and the deletion** of DocumentReference Resources related to Documents. Note that these events could be determined by Document Entry Objects updated or deleted in an XDS environment.

The canonical URL of this SubscriptionTopic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-DocReference-MultiPatient-AllEvents`.

The canonical instance of this extended SubscriptionTopic is reported here: [Multi-Patient DocumentReference SubscriptionTopic with DocumentReference Subscription for Full Events option](SubscriptionTopic-DSUBm-SubscriptionTopic-DocReference-MultiPatient-AllEvents.html).

#### 2:3.110.9.3 Patient-Dependent SubmissionSet Subscription Topic

For this type of subscription, the stream of events for which subscriptions are possible is limited to events representing the **creation** of SubmissionSet type List Resources related to SubmissionSet. Note that these events could be determined from SubmissionSet Objects created in an XDS environment. Note that these creation events could be happened with other events.

For this type of subscription, the possible subscription filter parameters are:

- `code`
- `patient`
- `patient.identifier`
- `source.given` and `source.family`
- `sourceId`
- `intendedRecipient`

For the definition of these parameters see [ITI-66 Query Search Parameters](https://profiles.ihe.net/ITI/MHD/ITI-66.html#23664121-query-search-parameters).

At least one of the patient or patient.identifier parameters shall be used.

Only the source.given, source.family, sourceId and intendedRecipient parameters may be multi-valued.

The canonical URL of this Subscription Topic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-SubmissionSet-PatientDependent`.

The Resource Notification Broker shall support all the filter parameter that are expressed in the SubscriptionTopic. The Resource Notification Broker shall determine if there is a Subscription which matches any of the SubmissionSet type List resources in an event. The evaluation performed is likely a search operation using the criteria in the Subscription. If it matches, the Resource Notification Broker shall send an [Event Notification Message [ITI-112]](ITI-112.html#231129-event-notification-request-message). If the `Subscription.payload.content` includes resources, the SubmissionSet type List resources shall be present.

The canonical instance of this SubscriptionTopic is reported here: [Patient-Dependent SubmissionSet SubscriptionTopic](SubscriptionTopic-DSUBm-SubscriptionTopic-SubmissionSet-PatientDependent.html).

#### 2:3.110.9.4 Multi-Patient SubmissionSet Subscription Topic

For this type of subscription, the stream of events for which subscriptions are possible is limited to events representing the **creation** of SubmissionSet type List Resources related to SubmissionSet. Note that these events could be determined from SubmissionSet Objects creation in an XDS environment. Note that these creation events could happen with other events.

For this type of subscription, the possible subscription filter parameters are:

- `code`
- `source.given` and `source.family`
- `sourceId`
- `intendedRecipient`

For the definition of these parameters see [ITI-66 Query Search Parameters](https://profiles.ihe.net/ITI/MHD/ITI-66.html#23664121-query-search-parameters).

All the parameters may be multi-valued.

The canonical URL of this SubscriptionTopic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-SubmissionSet-MultiPatient`.

The Resource Notification Broker shall support all the filter parameter that are expressed in the SubscriptionTopic. The Resource Notification Broker shall determine if there is a Subscription which matches any of the SubmissionSet type List resources in an event. The evaluation performed is likely a search operation using the criteria in the Subscription. If it matches, the Resource Notification Broker shall send an [Event Notification Message [ITI-112]](ITI-112.html#231129-event-notification-request-message). If the `Subscription.payload.content` includes resources, the SubmissionSet type List resources shall be present.

The canonical instance of this SubscriptionTopic is reported here: [Multi-Patient SubmissionSet SubscriptionTopic](SubscriptionTopic-DSUBm-SubscriptionTopic-SubmissionSet-MultiPatient.html).

#### 2:3.110.9.5 Basic Folder Subscription Topic
When the [Basic Folder Subscription option](volume-1.html#15423-basic-folder-subscription-option) is supported, this type of subscription is admitted. For this type of subscription, the stream of events for which subscriptions are possible is limited to events representing **the creation of Folder type List Resources and the update to insert new documents in Folder**. Note that these events could be determined from Folder Objects created or updated and Association Object creation in an XDS environment. Note that these creation or updating events could happen with other events.

For this type of subscription, the possible subscription filter parameters are:

- `code`
- `patient`
- `patient.identifier`
- `identifier`
- `designationType`
- `status`

For the definition of these parameters see [ITI-66 Query Search Parameters](https://profiles.ihe.net/ITI/MHD/ITI-66.html#23664121-query-search-parameters).

At least one of the patient or patient.identifier parameters shall be used.

Only the identifier and designationType parameters may be multi-valued.

The canonical URL of this SubscriptionTopic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-Basic-Folder-Subscription`.

The Resource Notification Broker shall support all the filter parameter that are expressed in the SubscriptionTopic. The Resource Notification Broker shall determine if there is a Subscription which matches any of the Folder type List resources in an event. The evaluation performed is likely a search operation using the criteria in the Subscription. If it matches, the Resource Notification Broker shall send an [Event Notification Message [ITI-112]](ITI-112.html#231129-event-notification-request-message). If the `Subscription.payload.content` includes resources, the Folder type List resources shall be present.

The canonical instance of this SubscriptionTopic is reported here: [Basic Folder SubscriptionTopic](SubscriptionTopic-DSUBm-SubscriptionTopic-Basic-Folder-Subscription.html).

##### 2:3.110.9.5.1 Folder Subscription with Folder Subscription for Minimal Update option Topic

When the [Folder Subscription for Minimal Update option](volume-1.html#15424-folder-subscription-for-minimal-update-option) is supported, this Subscription Topic extends the [Basic Folder Subscription Topic](#2311095-basic-folder-subscription-topic) in this way:

- the stream of events for which subscriptions are possible **includes** also events representing the **update to remove documents and update of the "status"** of Folder type List Resources related to Folders. Note that these events could be determined from Folder Objects update or Association Objects update or delete in an XDS environment.

The canonical URL of this Subscription Topic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-Folder-Subscription-MinUpdateOpt`.

The canonical instance of this SubscriptionTopic is reported here: [Folder SubscriptionTopic with Folder Subscription for Minimal Update option](SubscriptionTopic-DSUBm-SubscriptionTopic-Folder-Subscription-MinUpdateOpt.html).

##### 2:3.110.9.5.2 Folder Subscription with Folder Subscription for Update option Topic

When the [Folder Subscription for Update option](volume-1.html#15425-folder-subscription-for-update-option) is supported, this Subscription Topic extends the [Basic Folder Subscription Topic](#2311095-basic-folder-subscription-topic) in this way:

- the stream of events for which subscriptions are possible **includes** also events representing **all the updates** of Folder type List Resources related to Folders. Note that these events could be determined from Folder Objects update or Association Objects creation, update or delete in an XDS environment.

The canonical URL of this Subscription Topic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-Folder-Subscription-UpdateOpt`.

The canonical instance of this SubscriptionTopic is reported here: [Folder SubscriptionTopic with Folder Subscription for Minimal Update option](SubscriptionTopic-DSUBm-SubscriptionTopic-Folder-Subscription-UpdateOpt.html).

##### 2:3.110.9.5.3 Folder Subscription with Folder Subscription for Full Events option Topic

When the [Folder Subscription for Full Events option](volume-1.html#15426-folder-subscription-for-full-events-option) is supported, this Subscription Topic extends the [Basic Folder Subscription Topic](#2311095-basic-folder-subscription-topic) in this way:

- the stream of events for which subscriptions are possible **includes** also events representing **all the updates and the deletion** of Folder type List Resources related to Folders. Note that these events could be determined from Folder Objects update or deletion, or Association Objects creation, update or delete in an XDS environment.

The canonical URL of this Subscription Topic that shall be used in the `Subscription.criteria` element is `https://profiles.ihe.net/ITI/DSUBm/DSUBm-SubscriptionTopic-Folder-Subscription-for-Full-Events`.

The canonical instance of this SubscriptionTopic is reported here: [Folder SubscriptionTopic with Folder Subscription for Full Events option option](SubscriptionTopic-DSUBm-SubscriptionTopic-Folder-Subscription-for-Full-Events.html).


### 2:3.110.10 Mapping between DSUBm Criteria and DSUB subscription Filters. 
If the Resource Notification Broker is grouped with Document Metadata Subscriber and Document Metadata Notification Recipient, considering [DSUBm as an interface for DSUB](volume-1.html#15463-dsubm-as-an-interface-for-dsub) model, the `Subscription.criteria` available parameters in the Subscription resource shall be mapped with the DSUB filter Expression. 

<a name="table-docRef"> </a>

**Table 2:3.110.10-1: DSUBm DocumentReference subscription criteria mapping to DSUB DocumentEntry Filters**

| **DSUBm<br>Subscription.criteria** 	| **DSUB <br>DocumentEntry Filters**      	|
|------------------------------------------------	|---------------------------------------------	|
| author.given / author.family                   	| $XDSDocumentEntryAuthorPerson               	|
| category                                       	| $XDSDocumentEntryClassCode                  	|
| event                                          	| $XDSDocumentEntryEventCodeList              	|
| facility                                       	| $XDSDocumentEntryHealthcareFacilityTypeCode 	|
| format                                         	| $XDSDocumentEntryFormatCode                 	|
| patient or patient.identifier                  	| $XDSDocumentEntryPatientId                  	|
| security-label                                 	| $XDSDocumentEntryConfidentialityCode        	|
| type                                           	| $XDSDocumentEntryTypeCode                   	|
| status                                         	| none                                        	|
{: .grid}


<a name="table-submiss"> </a>

**Table 2:3.110.10-2: DSUBm SubmissionSet subscription criteria mapping to DSUB DocumentEntry Filters**

| **DSUBm<br>Subscription.criteria** |    **DSUB <br>SubmissionSet Filters**   |
|------------------------------------------------|---------------------------------------------|
| code                                           | none               |
| patient or patient.identifier                  | $XDSSubmissionSetPatientId                  |
| source.given or source.family                  | $XDSSubmissionSetAuthorPerson              |
| sourceId                                       | $XDSSubmissionSetSourceId              |
| intendedRecipient                              | $XDSSubmissionSetIntendedRecipient |
{: .grid}

<a name="table-folder"> </a>

**Table 2:3.110.10-3: DSUBm Folder subscription criteria mapping to DSUB DocumentEntry Filters**

| **DSUBm<br>Subscription.criteria** |    **DSUB <br>Folder Filters**   |
|------------------------------------------------|---------------------------------------------|
| code                                           | none             |
| patient or patient.identifier                  | $XDSFolderPatientId                 |
| identifier                                     | $XDSFolderUniqueId              |
| designationType                                | $XDSFolderCodeList |
| status                                         | none                                        |
{: .grid}
 
### 2:3.110.11 CapabilityStatement Resource
The Resource Notification Subscriber implementing this transaction shall provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
The possible CapabilityStatements for the Resource Notification Subscriber ar listed in Section [1:54.1.1.2 Resource Notification Subscriber](volume-1.html#154112-resource-notification-subscriber).

The Resource Notification Broker implementing this transaction shall provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
The possible CapabilityStatements for the Resource Notification Broker ar listed in Section [1:54.1.1.1 Resource Notification Broker](volume-1.html#154111-resource-notification-broker).


### 2:3.110.12 Security Considerations 
See [DSUBm Security Considerations](volume-1.html#1545-security-considerations). 

The Resource Notification Broker shall control that the Resource Notification Subscriber is acceptable and authorized to create or update a Subscription Resource. It's highly recommended that the Resource Notification Subscriber should use some form of authentication method when creating or updating a Subscription.
The Resource Notification Broker shall also be aware and enforce any agreed policy in order to control that the Subscription criteria received, that describe the notification event, are permitted to the authenticated Resource Notification Subscriber. For example a veterinary clinical record may be allowed to request a subscription but the Resource Notification Broker shall verify that the Subscription is related only to documents produced for animal subjects and shall reject any subscription made for documents produced for human subjects. 

If there is a policy that needs to be enforced in order to control which subscriber can Subscribe or Unsubscribe then, the Resource Notification Broker might maintain a whitelist of acceptable senders for the ITI-110 transactions. 
The Resource Notification Broker may enforce some control on the `channel.endpoint` element of the Subscription resource received in order to control where the notification will be sent. The Resource Notification Broker might maintain an allow-list of acceptable endpoints or trusted certificate authorities for rest-hook channels.
The Resource Notification Broker may control the `Subscription.payload` element of Subscription resource received in order to mitigate the risk of disclosing sensitive information. For example, if the Subscription criteria includes sensitive documents, the Resource Notification Broker may allow just 'id-only' payloads. In this way further authorization mechanisms shall be enforced when the Resource Notification Recipient tries to retrieve the information using the id. 

#### 2:3.110.12.1 Security Audit Considerations

The Resource Notification Subscriber, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record fundamental AuditEvents for: 
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Create](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Create.html) when a subscribe interaction is performed;
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Update](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Update.html) when an unsubscribe interaction is performed.

The Resource Notification Broker,  when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record fundamental AuditEvents for: 
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Create](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Create.html) when a subscribe interaction is performed;
- [BALP](https://profiles.ihe.net/ITI/BALP/index.html)[Update](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Update.html) when an unsubscribe interaction is performed.

