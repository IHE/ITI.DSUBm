This section corresponds to the transaction [ITI-110] Resource Subscription of the IHE Technical Framework. The [ITI-110] Resource Subscription is used by the Resource Notification Subscriber and Resource Notification Broker actors to submit a subscription in order to receive a notification.

## 3.110.1 Scope

The Resource Subscription [ITI-110] transaction passes a Resource Subscription Request from a Resource Notification Subscriber to a Resource Notification Broker. This transaction can be used to **create a new Subscription** or to **update an existing Subscription**. The update of the subscription is intendet to be used to change an existing subscription or to unsubscribe (deactivate) an existing Subscription. 

## 3.110.2 Actors Roles

**Table: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Subscriber](volume-1.html#subscriber)    | Sends the Subscription request to the Resource Notification Broker |
| [Resource Notification Broker](volume-1.html#broker) | Receives and processes the Subscription request |
{: .grid}

## 3.110.3 Referenced Standards

**FHIR-R4** [HL7 FHIR Release 4.0.1](https://www.hl7.org/FHIR/R4)

## 3.110.4 Interactions

<figure>
{%include ITI-110-seq.svg%}
<figcaption><b>Figure 2:3.110: ITI-110 interactions</b></figcaption>
</figure>
<br clear="all">

### 3.110.5 Create Subscription Request Message
This message uses the HTTP POST method on the target Resource Notification Broker endpoint to submit the subscription resource.

#### 3.110.5.1 Trigger Events

This method is invoked when the Resource Notification Subscriber needs to submit a new subscription resource to the Resource Notification Broker. The Resource Notification Subscriber shall have already discovered the SubscriptionTopic supported by the Resource Notification Broker in order to made a subscription. 
<!-- add some other information about Subscription topic discover based on Backport in R4 and what is define in oyr profile-->

#### 3.110.5.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4/http.html#create)” interaction. The message uses an HTTP POST method to submit a Subscription FHIR Resource as specify in [3.110.5.2.1 Subscription Resource paragraph]()<!--link-->.

The Resource Notification Subscriber actor shall submit the FHIR Subscription resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.

The Subscription is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4/http.html](https://hl7.org/fhir/R4/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol.

##### 3.110.5.2.1 Subscription Resource

The Subscription resource shall be compliant with [Subscription](https://hl7.org/fhir/R4/Subscription.html) and shall support the [Profile: R4/B Topic-Based Subscription](http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-subscription). 

The `Subscription.criteria` element shall include the canonical URL to a SubscriptionTopic resource that represents the topic that the Subscription resource is related to. The `Subscription.criteria` element shall support the [FilterBy Criteria extension](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-filter-criteria.html#root). This extension shall be used to narrow the subscription triggering events defined in the related SubscriptionTopic resource.  

For document subscription, different types of subscription resources may be submitted to the Resource Notification Broker.

The DSUBm profile specifies the following types of subscriptions:

<table border="1" borderspacing="0" style='border: 1px solid black; border-collapse: collapse'>
  <tr class="header">
    <td>Subscription type</td>
    <td></td>
  </tr>
  <tr>
    <td><a href="">Patient-Dependent DocumentReference Subscriptions</a> </td>
    <td>
    <li>shall contain in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element the canonical URL to a SubscriptionTopic resource that represents <a href="#Patient-Dependent DocumentReference Subscription Topic">Patient-Dependent DocumentReference Subscription Topic</a></li>
    <li> the filter parameter that could be present in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> is listed in <a href="#Patient-Dependent DocumentReference Subscription Topic">Patient-Dependent DocumentReference Subscription Topic</a></li>
    <li>in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element shall be included a patient reference or a patient identifier using one of the <code class=" highlighter-rouge language-plaintext">patient</code> or the <code class=" highlighter-rouge language-plaintext">patient.identifier</code> parameters</li>
    </td>
  </tr>
  <tr>
    <td><a href="">Multi-Patient DocumentReference Subscriptions</a></td>
    <td>
    <li>shall contain in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element the canonical URL to a SubscriptionTopic resource that represents <a href="#Multi-Patient DocumentReference Subscriptions Topic">Multi-Patient DocumentReference Subscriptions Topic</a></li>
    <li> the filter parameter that could be present in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> is listed in <a href="#Multi-Patient DocumentReference Subscriptions Topic">Multi-Patient DocumentReference Subscriptions Topic</a></li>
    </td>
  </tr>
  <tr>
    <td><a href="">Patient-Dependent Folder Subscriptions</a></td>
    <td>
    <li>shall contain in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element the canonical URL to a SubscriptionTopic resource that represents <a href="#Patient-Dependent Folder Subscriptions Topic">Patient-Dependent Folder Subscriptions Topic</a></li>
    <li> the filter parameter that could be present in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> is listed in <a href="#Patient-Dependent Folder Subscriptions Topic">Patient-Dependent Folder Subscriptions Topic</a></li>
    <li>in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element shall be included a patient reference or a patient identifier using one of the <code class=" highlighter-rouge language-plaintext">patient</code> or the <code class=" highlighter-rouge language-plaintext">patient.identifier</code> parameters</li>
    <li>in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element shall be included the <code class=" highlighter-rouge language-plaintext">code</code> parameters that specify the Folder type for the List resource</li>
    </td>
  </tr>
  <tr>
    <td><a href="">Patient-Dependent SubmissionSet Subscriptions</a></td>
    <td>
    <li>shall contain in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element the canonical URL to a SubscriptionTopic resource that represents <a href="#Patient-Dependent SubmissionSet Subscriptions Topic">Patient-Dependent SubmissionSet Subscriptions Topic</a></li>
    <li> the filter parameter that could be present in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> is listed in <a href="#Patient-Dependent SubmissionSet Subscriptions Topic">Patient-Dependent SubmissionSet Subscriptions Topic</a></li>
    <li>in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element shall be included a patient reference or a patient identifier using one of the <code class=" highlighter-rouge language-plaintext">patient</code> or the <code class=" highlighter-rouge language-plaintext">patient.identifier</code> parameters</li>
    <li>in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element shall be included the <code class=" highlighter-rouge language-plaintext">code</code> parameters that specify the SubmissionSet type for the List resource</li>
    </td>
  </tr>
  <tr>
    <td><a href="">Multi-Patient SubmissionSet Subscriptions</a></td>
    <td>
    <li>shall contain in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element the canonical URL to a SubscriptionTopic resource that represents <a href="#Multi-Patient SubmissionSet Subscriptions Topic">Multi-Patient SubmissionSet Subscriptions Topic</a></li>
    <li> the filter parameter that could be present in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> is listed in <a href="#Multi-Patient SubmissionSet Subscriptions Topic">Multi-Patient SubmissionSet Subscriptions Topic</a></li>
    <li>in the <code class=" highlighter-rouge language-plaintext">Subscription.criteria</code> element shall be included the <code class=" highlighter-rouge language-plaintext">code</code> parameters that specify the SubmissionSet type for the List resource</li>
    </td>
  </tr>
</table>

All the subscription resources shall support the following extension:

- [filter Criteria](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-filter-criteria.html)
- [channel type]( http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-channel-type)
- [payload content](http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-payload-content)

The Resource Notification Subscriber shall indicate in the `Subscription.payload.content` element the level of detail of the future notification that the Resource Notification Broker will send. The payload content extension defines three types of payload: 

- `empty` = No resource content is transmitted in the notification payload.
- `id-only` = Only the resource id is transmitted in the notification payload.
- `full-resource` = The entire resource is transmitted in the notification payload.

All the Subscription resource shall have `Subscription.status="requested"`, a `channel.type = "rest-hook"` and the element `channel.endpoint` shall contain the URL that identified the Resource Notification Recipient to which is intended to send the notification.

All the Subscription resource may have `Subscription.end` element valued, indicating the instant when the subscription automatically terminate.

<!--COMMENT For the profiling of these three types of subscription FHIR resources see [here][(Subscription_mapping.html)]() !!! LINK !!!-->

#### 3.110.5.3 Expected Actions

Upon receiving the request message the Resource Notification Broker shall verify the following conditions: 

- the SubscriptionTopic (referred in the `Subscription.criteria` element received in the subscription resource) is valid;
- all requested filters are defined in the requested topic and are implemented in the Resource Notification Broker;
- the channel-type is `Subscription.channel-type="rest-hook"`;
- the channel endpoint is valid for the channel provided (e.g., is it a valid URL of the expected type);
- the payload configuration is known and implemented by the server
- the payload configuration is valid for the channel type requested (e.g., complies with the Resource Notification Broker security policy).

The Resource Notification Broker actor may support the handshake process to verify that the endpoint that identified the Resource Notification Recipient, in the `Subscription.channel.endpoint` element of the subscription resource, is reachable before activate the subscription. In this case the Resource Notiffication Broker shall send to the Resource Notification Recipient a [Handshake Notification]()<!--link-->(see [ITI-113]).
Note that if the Resource Notification Broker actor utilizes the handshake to verify the endpoint included in the subscription resource then the Resource Notification Subscriber shall implement the Subscription Search option in order to verify the activation of the subscription. 

The Resource Notification Broker shall be enforce all the Security Consideration defined [here.](#security_ITI-110)

Based on the outcome of the conditions above the Resource Notification Broker shall accept or reject the subscription resource received. If all the conditions are true the Resource Notification Broker shall create a Subscription resource and activate the subscription.

When in the Subscription Resource in use the `heartbeatPeriod`, if accepted, the Resource Notification Broker should send one [Heartbeat Notification]()<!--link--> (see [ITI-113]) per interval on the accepted subscription.

Once the Subscription is activeated, the Resource Notification Broker shall be capable of evaluate the events that occurs against the Subscription creteria and, if matches, shall send to the appropriate Resource Notification Recipient a [Event Notification]()<!--link-->(see [ITI-113]).

Further considerations needs to be done, for the activation of a Subscription, considering DSUBm as an interface for DSUB enviroment.

##### 3.110.5.3.1 Expected Actions with DSUBm as an interface for DSUB

If the Resource Notification Broker is grouped with Document Metadata Subscriber and Document Metadata Notification Recipient, considering DSUBm as an interface for DSUB ([see here](volume-1.html#154631-dsubm-as-an-interface-for-dsub)) if the subscription is accepted, the Resource Notification Broker shall trigger the Document Metadata Subscriber to make a subscription towards the Document Metadata Notification Broker with an [ITI-52] Document Metadata Subscribe transaction.

The mapping between the Subscription resource contained in the [ITI-110] Resource Subscription transaction and the [ITI-52] Document Metadata Subscribe transaction shall be as following:

- If the Subscription resource has a `Subscription.payload = "full-resource"` the DSUB subscription shall have a ["ihe:FullDocumentEntry" Topic Expression](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.2.2). Otherwise a ["ihe:MinimalDocumentEntry" Topic Expression](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.1.2) shall be used.

- Depending on the type of the Subscription, the AdHocQuery/@id attribute and the the Filters parameter of the ì[ITI-52] Document Metadata Subscribe transaction shall valued as following:

| Subscription type | AdHocQuery/@id | Filter parameter |
|-------------------+--------------+------------|
| Patient-Dependent DocumentReference Subscriptions  | `urn:uuid:aa2332d0-f8fe-11e0-be50-0800200c9a66` | mapping based on Table 2:3.67.4.1.3.1-1: ITI-18 FindDocuments Query Parameter Mapping of [XDS on FHIR Option](https://profiles.ihe.net/ITI/MHD/ITI-67.html#23674131-xds-on-fhir-option) paragraph of [ITI-67] Find Document References Transaction |
| Multi-Patient DocumentReference Subscriptions | `urn:uuid:742790e0-aba6-43d6-9f1fe43ed9790b79` | mapping based on Table 2:3.67.4.1.3.1-1: ITI-18 FindDocuments Query Parameter Mapping of [XDS on FHIR Option](https://profiles.ihe.net/ITI/MHD/ITI-67.html#23674131-xds-on-fhir-option) paragraph of [ITI-67] Find Document References Transaction |
| Patient-Dependent Folder Subscriptions | `urn:uuid:9376254e-da05-41f5-9af3-ac56d63d8ebd`| mapping based on Table 2:3.66.4.1.3.1-1: FindSubmissionSets Query Parameter Mapping of [XDS on FHIR Option](https://profiles.ihe.net/ITI/MHD/ITI-66.html#23664131-xds-on-fhir-option) paragraph of [ITI-66] Find Document List Transaction|
| Patient-Dependent SubmissionSet Subscriptions  | `urn:uuid:fbede94e-dbdc-4f6b-bc1f-d730e677cece`| mapping based on Table 2:3.66.4.1.3.1-1: FindSubmissionSets Query Parameter Mapping of [XDS on FHIR Option](https://profiles.ihe.net/ITI/MHD/ITI-66.html#23664131-xds-on-fhir-option) paragraph of [ITI-66] Find Document List Transaction|
| Multi-Patient SubmissionSet Subscriptions| `urn:uuid:868cad3d-ec09-4565-b66c-1be10d034399`| mapping based on Table 2:3.66.4.1.3.1-1: FindSubmissionSets Query Parameter Mapping of [XDS on FHIR Option](https://profiles.ihe.net/ITI/MHD/ITI-66.html#23664131-xds-on-fhir-option) paragraph of [ITI-66] Find Document List Transaction|
{: .grid}

- If the Subscription resource has `Subscription.end` element valued, the DSUB subscription shall have a `wsnt:InitialTerminationTime` element valued.

When the XDS DSUB subscription has a successfull result, the Resource Notification Broker shall mantein the coupling between the Subscription Resource Id and the webservice endpoint present in the Address element of the Unsubscribe Request message, in order to be capable of manage further unsubscription.

If the XDS Document Metadata Notification Broker sends an assigned duration for the subscription, the Resource Notification Broker shall associate the assigned duration with the accepted subscription request end eventually re-activate when expired.

### 3.110.6 Update Subscription Request Message
This message uses the HTTP PUT method on the target Resource Notification Broker endpoint to update an existing Subscription resource in order to de-activate it and unsubscribe.

#### 3.110.6.1 Trigger Events

This method is invoked when the Resource Notification Subscriber needs to unsubscribe for an already existing subscription so it sends un update of the Subscription resource to the Resource Notification Broker.

#### 3.110.6.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for "[update](https://hl7.org/fhir/R4/http.html#update)" interaction. The message uses an HTTP PUT method to submit a Subscription FHIR Resource previusly created as specify in 3.110.5.2.1 Constrain for the Subscription Resource paragraph. Plus the `Subscription.id` element shall be valued with the id of the subscription to be updated.
 
In order to unsubscribe the Subscription Resource shall have `Subscription.status=off`.

The Resource Notification Subscriber actor shall submit the FHIR Subscription resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.

The Resource Subscription message is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4/http.html](https://hl7.org/fhir/R4/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol.

#### 3.110.6.3 Expected Actions

Upon receiving the request message the Resource Notification Broker shall verify the following conditions: 

- that the Subscription resource to be updated exists (Prevent Update as Create);
- the status is `off`. 

The Resource Notification Broker shall be enforce all the Security Consideration defined [here.](#security_ITI-110)

Based on the outcome of the conditions above the Resource Notification Broker shall accept or reject the update of the subscription resource received. If all the conditions are true the Resource Notification Broker shall update a Subscription resource and de-activate the subscription .

Further considerations needs to be done in the following paragraph, considering DSUBm as an interface for DSUB enviroment.

##### 3.110.6.3.1 Expected Actions with DSUBm as an interface for DSUB

If the Resource Notification Broker is grouped with Document Metadata Subscriber and Document Metadata Notification Recipient, considering DSUBm as an interface for DSUB ([see here](volume-1.html#154631-dsubm-as-an-interface-for-dsub)) if the update of the subscription is accepted, the Resource Notification Broker shall trigger the Document Metadata Subscriber to send an [Unsubscribe Request message](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.4.3) towards the Document Metadata Notification Broker with an [ITI-52] Document Metadata Subscribe transaction. The message shall be sent to the webservices endpoint previously associated to the Subscription id (see 3.110.5.3.1 Expected Actions with DSUBm as an interface for DSUB). 

### 3.110.7 Update Subscription Response Message

The Resource Notification Broker sends a Resource Subscription Response message to respond to a Create Subscription Request Message or to an Update Resource Subscription Request message.  

#### 3.110.7.1 Trigger Events

When the Resource Notification Broker has finished evaluating the subscription received and the operation, the Resource Notification Broker sends this message to the Resource Notification Subscriber acknowledging the result of the creation or the update of the resource. 

#### 3.110.7.2 Message Semantics
When the Resource Notification Broker has processed the request, it shall return an HTTP response with an overall status code.

The Resource Notification Broker shall returns an HTTP status code appropriate to the request and the operation.

If the Subscription has been created the Resource Notification Broker shall respond with an `HTTP 201 Created` status code as indicated for "[create](https://hl7.org/fhir/R4/http.html#create)" and the Resource Notification Broker shall return the entire resource.
<!--specify the response in the case oh handshake with status requested and the full resource ? and clarify the expected action ?-->

If the Subscription has been updated the Resource Notification Broker shall respond with an `HTTP 200 OK` status code as indicated for "[update](https://hl7.org/fhir/R4/http.html#update)" and the Resource Notification Broker shall return the entire resource.

If the interaction failed, common HTTP Status codes returned on FHIR-related errors (in addition to normal HTTP errors related to security, header and content type negotiation issues) are:
- `400 Bad Request` - resource could not be parsed or failed basic FHIR validation rules (or multiple matches were found for conditional criteria)
- `401 Not Authorized` - authorization is required for the interaction that was attempted
- `404 Not Found` - resource type not supported, or not a FHIR end-point
- `405 Method Not allowed` - the resource did not exist prior to the update, and the server does not allow client defined ids
- `422 Unprocessable Entity` - the proposed resource violated applicable FHIR profiles or server business rules
Those should be accompanied by an [OperationOutcome](https://hl7.org/fhir/R4/operationoutcome.html) resource providing additional detail.

The Resource Notification Broker can return other status codes 4xx or 5xx in accordance to internal business rules that are out of scope for this transaction.

#### 3.110.7.3 Expected Actions

The Resource Notification Subscriber processes the response according to application-defined rules.

If the Resource Notification Subscriber had not indicated a requested duration for the subscription, the Resource Notification Broker may send an assigned duration for the subscription (if any), using the `Subscription.end` element.

If the Resource Notification Broker sends an assigned duration for the subscription, the Resource Notification Subscriber shall associate the assigned duration with the accepted subscription request.

The Resource Notification Subscriber shall associate the accepted subscription request with the subscription id assigned by the Resource Notification Broker in order to be able to send cancellations for existing subscriptions.

## 3.110.8 Subscription Topic

<a name="Patient-Dependent DocumentReference Subscription Topic"> </a>

### 3.110.8.1 Patient-Dependent DocumentReference Subscription Topic

<a name="Multi-Patient DocumentReference Subscriptions Topic"> </a>

### 3.110.8.2 Multi-Patient DocumentReference Subscriptions Topic

<a name="Patient-Dependent Folder Subscription Topic"> </a>

### 3.110.8.3 Patient-Dependent Folder Subscription Topic

<a name="Patient-Dependent SubmissionSet Subscription Topic"> </a>

### 3.110.8.4 Patient-Dependent SubmissionSet Subscription Topic

<a name="Multi-Patient SubmissionSet Subscription Topic"> </a>

### 3.110.8.5 Multi-Patient SubmissionSet Subscription Topic


## 3.110.9 CapabilityStatement Resource

The Resource Notification Broker implementing this transaction shall provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [broker](CapabilityStatement-IHE.DSUBm.client.html)

The Resource Notification Subscriber implementing this transaction shall provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [suscriber](CapabilityStatement-IHE.DSUBm.client.html)

<a name="security_ITI-110"> </a>

## 3.110.10 Security Considerations 
See [DSUBm Security Considerations](volume-1.html#security-considerations). 

The Resource Notification Broker shall control that the Resource Notification Subscriber is acceptable and authorised to create/update a Subscription Resource. 
The Resource Notification Broker shall also be aware and enforce any agreed policy in order to control that the Subscription criteria received, that describe the notification event, are permitted to the Resource Notification Subscriber. For example a veterinary clinical record may be allowed to reqeust for subscription but the Resource Notification Broker shall verify that the Subscription is relataed only to documents produced for animal subjects and shall reject any subscription made for documnets produced for human subjects. 

The Resource Notification Broker might maintain a whitelist of acceptable senders for the rest-create/rest-update methods. 
The Resource Notification Broker may enforce some control on `channel.endpoint` element of Subscription resource received in order to control where the notification will be sent. The Resource Notification Broker might maintain a allow-list of acceptable endpoints or trusted certificate authorities for rest-hook channels.
The Resource Notification Broker may control the `Subscription.payload` element of Subscription resource received in order to mitigate the risk of disclosing sensitive information. For example, if the Subscription criteria includes sensitive documents, the Resource Notification Broker may allow just 'id-only' payloads. In this way further authorization mechanism shall be enforced when the Resource Notification Recipient tries to recover the information using the id. 

### 3.110.10.1 Security Audit Considerations

''TODO: The security audit criteria ''

##### 3.110.10.1.1 Client Audit 

''TODO: the specifics''

##### 3.110.10.1.2 Server Audit 

''TODO: the specifics''
