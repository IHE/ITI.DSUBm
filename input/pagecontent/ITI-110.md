This section corresponds to the transaction [ITI-110] Resource Subscription of the IHE Technical Framework. The [ITI-110] Resource Subscription is used by the Resource Notification Subscriber and Resource Notification Broker actors to submit a subscription in order to receive a notification.

## 3.110.1 Scope

The Resource Subscription [ITI-110] transaction passes a Resource Subscription Request from a Resource Notification Subscriber to a Resource Notification Broker. This transaction can be used to **create a new Subscription** or to **update an existing Subscription**. The update of the subscription is intended to be used only to **unsubscribe (deactivate)** an existing Subscription. 

## 3.110.2 Actors Roles

**Table: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Subscriber](volume-1.html#subscriber)    | Sends the Subscription request to the Resource Notification Broker |
| [Resource Notification Broker](volume-1.html#broker) | Receives and processes the Subscription request |
{: .grid}

## 3.110.3 Referenced Standards

**FHIR-R4B** [HL7 FHIR Release 4.3.0](https://www.hl7.org/FHIR/R4B)

## 3.110.4 Interactions

<figure>
{%include ITI-110-seq.svg%}
<figcaption><b>Figure 2:3.110: ITI-110 interactions</b></figcaption>
</figure>
<br clear="all">

### 3.110.5 Create Subscription Request Message
This message uses the HTTP POST method on the target Resource Notification Broker endpoint to submit the Subscription resource.

#### 3.110.5.1 Trigger Events

This method is invoked when the Resource Notification Subscriber needs to submit a new subscription resource to the Resource Notification Broker. The Resource Notification Subscriber shall have already discovered the SubscriptionTopic supported by the Resource Notification Broker in order to made a subscription. 
<!-- add some other information about Subscription topic discover based on Backport in R4 and what is define in oyr profile-->

#### 3.110.5.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4B/http.html#create)” interaction. The message uses an HTTP POST method to submit a Subscription FHIR Resource as specify in [3.110.5.2.1 Subscription Resource paragraph](#Subscription-Resource)<!--link-->.

The Resource Notification Subscriber actor shall submit the FHIR Subscription resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.

The Subscription is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol. The HTTPS protocol is highly recommended.

<a name="Subscription-Resource"> </a>

##### 3.110.5.2.1 Subscription Resource

The Subscription resource shall be compliant with [Subscription](https://hl7.org/fhir/R4B/Subscription.html) and shall be compliant with [Profile: R4/B Topic-Based Subscription](http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-subscription). 

The `Subscription.criteria` element shall include the canonical URL to a SubscriptionTopic resource that represents the Topic that the Subscription resource is related to. The `Subscription.criteria` element shall support the [FilterBy Criteria extension](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-filter-criteria.html#root). This extension shall be used to narrow the subscription triggering events defined in the related SubscriptionTopic resource.  

All the Subscription resources shall support the following extension:

- [channel type]( http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-channel-type)
- [payload content](http://hl7.org/fhir/uv/subscriptions-backport/StructureDefinition/backport-payload-content)

The Resource Notification Subscriber shall indicate in the `Subscription.payload.content` element the level of detail of the future notification that the Resource Notification Broker will send. The payload content extension defines three types of payload: 

- `empty` = No resource content is transmitted in the notification payload.
- `id-only` = Only the resource id is transmitted in the notification payload.
- `full-resource` = The entire resource is transmitted in the notification payload.

All the Subscription resource shall have `Subscription.status="requested"`, a `channel.type = "rest-hook"` and the element `channel.endpoint` shall contain the URL that identified the Resource Notification Recipient to which is intended to send the notification.

All the Subscription resource may have `Subscription.end` element valued, indicating the instant when the subscription automatically terminate.

For documents, different types of subscription resources may be submitted to the Resource Notification Broker.

This profile defines the following types of Subscriptions with relative Subscription Topic:

  | Subscription type | Subscription Topic |
  |-------------------+----------------|
  | [Patient-Dependent DocumentReference Subscriptions]()  |[Patient-Dependent DocumentReference Subscription Topic](#311081-patient-dependent-documentreference-subscription-topic) |
  | [Multi-Patient DocumentReference Subscription]() |[Multi-Patient DocumentReference Subscriptions Topic](#311082-multi-patient-documentreference-subscriptions-topic)|
  | [Patient-Dependent Folder Subscriptions]() |[Patient-Dependent Folder Subscription Topic](#311083-patient-dependent-folder-subscription-topic) |
  | [Patient-Dependent SubmissionSet Subscriptions]()  | [Patient-Dependent SubmissionSet Subscription Topic](#311084-patient-dependent-submissionset-subscription-topic) |
  | [Multi-Patient SubmissionSet Subscriptions]() |[Multi-Patient SubmissionSet Subscription Topic](#311085-multi-patient-submissionset-subscription-topic) |
  {: .grid}


##### 3.110.5.2.1.1 Subscription with Updates to document sharing resources option

When supported the Updating events option, this profile defines also the following types of Subscriptions with relative Subscription Topic:

  | Subscription type | Subscription Topic |
  |-------------------+----------------|
  | [Patient-Dependent DocumentReference Subscriptions with updates to document sharing resources option]()  |[Patient-Dependent DocumentReference SubscriptionTopic with updates to document sharing resources option to document sharing resources option](#3110811-patient-dependent-documentreference-subscription-with-updates-topic) |
  | [Multi-Patient DocumentReference Subscription with updates to document sharing resources option]() |[Multi-Patient DocumentReference SubscriptionTopic with Updates to document sharing resources option](#3110821-multi-patient-documentreference-subscription-with-updates-topic)|
  | [Patient-Dependent Folder Subscription with Updates to document sharing resources option]() |[Patient-Dependent Folder SubscriptionTopic with Updates to document sharing resources option](#3110831-patient-dependent-folder-subscription-with-updates-topic) |
  {: .grid}

#### 3.110.5.3 Expected Actions

Upon receiving the request message the Resource Notification Broker shall verify the following conditions: 

- the SubscriptionTopic (referred in the `Subscription.criteria` element received in the subscription resource) is valid;
- all requested filters are defined in the requested topic and are implemented in the Resource Notification Broker;
- the channel-type is `rest-hook`;
- the channel endpoint is valid for the channel provided (e.g., is it a valid URL of the expected type);
- the payload configuration is known and implemented by the server
- the payload configuration is valid for the channel type requested (e.g., complies with the Resource Notification Broker security policy).

The Resource Notification Broker actor shall support the handshake process to verify that the endpoint that identified the Resource Notification Recipient, in the `Subscription.channel.endpoint` element of the subscription resource, is reachable before activate the subscription.
The Resource Notification Broker shall set initial status to `requested`, pending verification of the nominated endpoint URL. In this case the Resource Notification Broker shall send to the Resource Notification Recipient a [Handshake Notification Message [ITI-112]](ITI-112.html#31125-handshake-notification-message). After a successful handshake notification has been sent and accepted, the Resource Notification Broker shall update the status to `active`. Any errors in the initial handshake shall result in the status being changed to `error`. Note that the Resource Notification Subscriber should implement the transaction [ITI-113](ITI-113.html) Subscription Search in order to verify the activation of the subscription. 

The Resource Notification Broker shall be enforce all the Security Consideration defined [here.](#security_ITI-110)

The Resource Notification Broker may evaluate to not duplicate a Subscription on the base of the informations transmitted in the request message (e.g. criteria, endpoint, user authentication, etc.) in order to prevent on multiple Subscription and Notification.

Based on the outcome of the conditions above the Resource Notification Broker shall accept or reject the subscription resource received. If all the conditions are true the Resource Notification Broker shall create a Subscription resource and activate the subscription.

When in the Subscription Resource in use the `heartbeatPeriod`, if accepted, the Resource Notification Broker should send one [Heartbeat Notification Message [ITI-112]](ITI-112.html#31126-heartbeat-notification-message) per interval on the accepted subscription.

Once the Subscription is activated, the Resource Notification Broker shall be capable of evaluate the events that occurs against the Subscription creteria and, if matches, shall send to the appropriate Resource Notification Recipient a [Event Notification Message [ITI-112]](ITI-112.html#31127-event-notification-message).

Further considerations needs to be done, for the activation of a Subscription, considering DSUBm as an interface for DSUB enviroment.

##### 3.110.5.3.1 Expected Actions with DSUBm as an interface for DSUB

If the Resource Notification Broker is grouped with Document Metadata Subscriber and Document Metadata Notification Recipient, considering [DSUBm as an interface for DSUB](volume-1.html#154631-dsubm-as-an-interface-for-dsub) model, if the subscription is accepted, the Resource Notification Broker shall trigger a [Subscribe Request message](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.4.2) towards the DSUB Document Metadata Notification Brokerthe DSUB Document Metadata Subscriber with an [ITI-52] Document Metadata Subscribe transaction.

The mapping between the Subscription resource contained in the [ITI-110] Resource Subscription transaction and the [ITI-52] Document Metadata Subscribe transaction shall be as following:

- If the Subscription resource has a `Subscription.payload = "full-resource"` the [ITI-52] Document Metadata Subscribe transaction shall have a ["ihe:FullDocumentEntry" Topic Expression](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.2.2). Otherwise a ["ihe:MinimalDocumentEntry" Topic Expression](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.5.1.2) shall be used.

- Depending on the type of the Subscription, the AdHocQuery/@id attribute and the the Filters parameter of the [ITI-52] Document Metadata Subscribe transaction shall valued as following:

  | Subscription type | AdHocQuery/@id | Filter parameter |
  |-------------------+--------------+------------|
  | Patient-Dependent DocumentReference Subscriptions  | `urn:uuid:aa2332d0-f8fe-11e0-be50-0800200c9a66` | Mapping based on [Table 3:110.9-1](#table-docRef) |
  | Multi-Patient DocumentReference Subscriptions | `urn:uuid:742790e0-aba6-43d6-9f1fe43ed9790b79` | Mapping based on [Table 3:110.9-1](#table-docRef) |
  | Patient-Dependent Folder Subscriptions | `urn:uuid:9376254e-da05-41f5-9af3-ac56d63d8ebd`|Mapping based on [Table 3:110.9-2](#table-folder) |
  | Patient-Dependent SubmissionSet Subscriptions  | `urn:uuid:fbede94e-dbdc-4f6b-bc1f-d730e677cece`| Mapping based on [Table 3:110.9-3](#table-submiss)|
  | Multi-Patient SubmissionSet Subscriptions| `urn:uuid:868cad3d-ec09-4565-b66c-1be10d034399`|Mapping based on [Table 3:110.9-3](#table-submiss) |
  {: .grid}

- If the Subscription resource has `Subscription.end` element valued, the [ITI-52] Document Metadata Subscribe transaction shall have a `wsnt:InitialTerminationTime` element valued.

When the [ITI-52] Document Metadata Subscribe transaction has a successfull result, the Resource Notification Broker shall mantein the coupling between the Subscription Resource id and the webservice endpoint present in the `Address` element of the [ITI-52] Document Metadata Subscribe response message, in order to be capable of manage further unsubscription.

If the DSUB Document Metadata Notification Broker sends an assigned duration for the subscription, the Resource Notification Broker shall associate the assigned duration with the accepted subscription request end eventually re-activate the subscription towards the DSUB Document Metadata Notification Broker when expired.

### 3.110.6 Update Subscription Request Message
This message uses the HTTP PUT method on the target Resource Notification Broker endpoint to update an existing Subscription resource in order to de-activate it and unsubscribe.

#### 3.110.6.1 Trigger Events

This method is invoked when the Resource Notification Subscriber needs to unsubscribe for an already existing subscription so it sends un update of the Subscription resource to the Resource Notification Broker.

#### 3.110.6.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for "[update](https://hl7.org/fhir/R4B/http.html#update)" interaction. The message uses an HTTP PUT method to update a Subscription FHIR Resource previusly created (see section [3.110.5 Create Subscription Request Message](#31105-create-subscription-request-message)). 

The `Subscription.id` element shall be valued with the id of the Subscription to be updated.
 
In order to unsubscribe, the Subscription Resource shall have `Subscription.status=off`.

The Resource Notification Subscriber actor shall submit the FHIR Subscription resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.

The Resource Subscription message is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol. The HTTPS protocol is highly recommended.

#### 3.110.6.3 Expected Actions

Upon receiving the request message the Resource Notification Broker shall verify the following conditions: 

- that the Subscription resource to be updated exists (Prevent Update as Create);
- the status is `off`. 

The Resource Notification Broker shall be enforce all the Security Consideration defined [here](#security_ITI-110).

Based on the outcome of the conditions above the Resource Notification Broker shall accept or reject the update of the subscription resource received. If all the conditions are true the Resource Notification Broker shall update a Subscription resource and de-activate the subscription. If deativated, the Resource Notification Broker should sent a [Subscription Deactivation Notification [ITI-112]](ITI-112.html#31128-subscription-deactivation-notification-message) to the Resource Notification Recipient. 

Further considerations needs to be done in the following paragraph, considering DSUBm as an interface for DSUB enviroment.

##### 3.110.6.3.1 Expected Actions with DSUBm as an interface for DSUB

If the Resource Notification Broker is grouped with Document Metadata Subscriber and Document Metadata Notification Recipient, considering [DSUBm as an interface for DSUB](volume-1.html#154631-dsubm-as-an-interface-for-dsub) model, if the update of the subscription is accepted, the Resource Notification Broker shall trigger the Document Metadata Subscriber to send an [Unsubscribe Request message](https://profiles.ihe.net/ITI/TF/Volume2/ITI-52.html#3.52.4.3) towards the Document Metadata Notification Broker with an [ITI-52] Document Metadata Subscribe transaction. The message shall be sent to the webservices endpoint previously associated to the Subscription id (see [3.110.5.3.1 Expected Actions](#3110531-expected-actions-with-dsubm-as-an-interface-for-dsub) section). 

### 3.110.7 Subscription Response Message

The Resource Notification Broker sends a Resource Subscription Response Message to respond to a Create Subscription Request Message or to an Update Subscription Request Message.  

#### 3.110.7.1 Trigger Events

When the Resource Notification Broker has finished evaluating the subscription received and the operation, the Resource Notification Broker sends this message to the Resource Notification Subscriber acknowledging the result of the creation or the update of the resource. 

#### 3.110.7.2 Message Semantics
When the Resource Notification Broker has processed the request, it shall return an HTTP response with an overall status code.

The Resource Notification Broker shall returns an HTTP status code appropriate to the request and the operation.

If the Subscription has been created, the Resource Notification Broker shall respond with an `HTTP 201 Created` status code as indicated for "[create](https://hl7.org/fhir/R4B/http.html#create)" and the Resource Notification Broker shall return the entire resource in which the status shall be `requested`. If the Resource Notification Broker has assigned a termination time, the element `end` shall be evaluated.

If the Subscription has been updated, the Resource Notification Broker shall respond with an `HTTP 200 OK` status code as indicated for "[update](https://hl7.org/fhir/R4B/http.html#update)" and the Resource Notification Broker shall return the entire resourcein which the status shall be `off`.

If the interaction failed, common HTTP Status codes returned on FHIR-related errors (in addition to normal HTTP errors related to security, header and content type negotiation issues) are:
- `400 Bad Request` - resource could not be parsed or failed basic FHIR validation rules (or multiple matches were found for conditional criteria)
- `401 Not Authorized` - authorization is required for the interaction that was attempted
- `404 Not Found` - resource type not supported, or not a FHIR end-point
- `405 Method Not allowed` - the resource did not exist prior to the update, and the server does not allow client defined ids
- `422 Unprocessable Entity` - the proposed resource violated applicable FHIR profiles or server business rules
Those should be accompanied by an [OperationOutcome](https://hl7.org/fhir/R4B/operationoutcome.html) resource providing additional detail.

The Resource Notification Broker can return other status codes 4xx or 5xx in accordance to internal business rules that are out of scope for this transaction.

#### 3.110.7.3 Expected Actions

The Resource Notification Subscriber processes the response according to application-defined rules.

For the Subscription creation:

  - If the Resource Notification Subscriber had not indicated a requested duration for the subscription, the Resource Notification Broker may send an assigned duration for the subscription (if any), using the `Subscription.end` element.

  - If the Resource Notification Broker sends an assigned duration for the subscription, the Resource Notification Subscriber shall associate the assigned duration with the accepted subscription request.

  - The Resource Notification Subscriber shall associate the accepted subscription request with the subscription id assigned by the Resource Notification Broker in order to be able to send cancellations for existing subscriptions.

## 3.110.8 Subscription Topic and Filter Expressions

In this section are clarify what are the Subscription Topic and what are the filter parameters for each type of Subscription that this profile defines. 

Further, for each type of subscription are specify the streams of events for which subscriptions are possible and that the Resource Notification Broker shall evaluate. The Resource Notification Broker becomes aware of such events either via a Resource Publish [ITI-111] transaction, or via other mechanisms not specified by IHE.

<a name="Patient-Dependent DocumentReference Subscription Topic"> </a>

### 3.110.8.1 Patient-Dependent DocumentReference Subscription Topic

For this type of subscription, the stream of events for which subscriptions are possible is limited to events representing the **creation** of DocumentReference Resources related to Documents. Note that these events could be deteminated by Document Entry Objects creation in XDS enviroment. Note that these creation events could be happened with other events.

For this type of subscription, the possible subscription criteria parmeters are:

- `author.given` and `author.family`: These parameters, of type string, specify the name parts of the author person, which is associated with the DocumentReference Resource, or in Document Sharing nomenclature, the author of the Document Entry. See ITI TF-2x: Appendix Z.2 for use of the string data type. This use of author.given and author.family follows the FHIR Chaining Parameters search methodology.

- `category`: This parameter, of type token, specifies the general classification of the DocumentReference Resource, or in Document Sharing nomenclature, the classCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `event`: This parameter, of type token, specifies the main clinical acts documented by the DocumentReference Resource, or in Document Sharing nomenclature, the eventCodeList of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `facility`: This parameter, of type token, specifies the kind of facility found in DocumentReference.context.facilityType, or in Document Sharing nomenclature, the healthcareFacilityTypeCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `format`: This parameter, of type token, specifies the format of the DocumentReference Resource, or in Document Sharing nomenclature, the formatCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `patient`: This parameter is of type Reference(Patient). The Document Consumer may get this reference using the PDQm or PIXm Profile. When the patient parameter is used, the Patient reference would need to be accessible to both the Resource Notification Subscriber and the Resource Notification Broker.

- `patient.identifier`: This parameter, of type token, specifies an identifier associated with the patient to which the DocumentReference Resource is assigned. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type. This use of patient.identifier follows the FHIR Chaining Parameters search methodology.

- `security-label`: This parameter, of type token, specifies the security labels of the document referenced by DocumentReference Resource, or in Document Sharing nomenclature, the confidentialityCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `setting`: This parameter, of type token, specifies the specific practice setting of the DocumentReference Resource, or in Document Sharing nomenclature, the practiceSettingCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `type`: This parameter, of type token, specifies the specific type of the DocumentReference resource or in Document Sharing nomenclature, the typeCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `status`: This parameter, of type token, specifies the status of the DocumentReference Resource, or in Document Sharing nomenclature, the availabilityStatus of the Document Entry. The Document Consumer shall populate the identifier portion of the token using one of the short codes in Table 2:3.67.4.1.2.1-1. The system portion of the token shall not be populated.

At least one of the patient or patient.identifier parameter shall be used.

With the exception of status, patient or patient.identifier, all parameters may be multi-valued.

The canonical URL to this Subscription Topic that shall be used in the `Subscription.criteria` element shall be `urn:uuid:aa2332d0-f8fe-11e0-be50-0800200c9a66`.

The Resource Notification Broker shall determine if there is a Subscription which matches any of the DocumentReference resources in an event. The evaluation should be performed likely a search operation using the criteria in the Subscription. If matches, the Resource Notification Broker shall send a [Event Notification]() (see [ITI-112](ITI-112.html) transaction). If the `Subscription.payload.content` includes resources, the DocumentReference resources shall be present.

A canonical instances of this Subscription Topic is reported here: [Patient-Dependent DocumentReference Subscription Topic](Basic-DocumentReference-PatientDependent-CUD.html).


#### 3.110.8.1.1 Patient-Dependent DocumentReference Subscription Subscription with Updates to document sharing resources option Topic

When supported the Updating events option, this Subscription Topic extends the [Patient-Dependent DocumentReference Subscription Topic](#311081-patient-dependent-documentreference-subscription-topic) in this way:

- the stream of events for which subscriptions are possible **includes** also events representing the **update or the deletion** of DocumentReference Resources related to Documents. Note that these events could be deteminated by Document Entry Objects update or deletion in XDS enviroment.

The canonical URL to this Subscription Topic that shall be used in the `Subscription.criteria` element shall be `TO DEFINE`.

A canonical instances of this Subscription Topic is reported here: [Patient-Dependent DocumentReference Subscription Subscription with Updates to document sharing resources option Topic]().

<a name="Multi-Patient DocumentReference Subscriptions Topic"> </a>

### 3.110.8.2 Multi-Patient DocumentReference Subscriptions Topic

For this type of subscription, the stream of events for which subscriptions are possible is limited to events representing the **creation** of DocumentReference Resources related to Documents. Note that these events could be deteminated from Document Entry Objects creation in XDS enviroment. Note that these creation events could be happened with other events.

For this type of subscription, the possible subscription criteria parmeters are:

- `author.given` and `author.family`: These parameters, of type string, specify the name parts of the author person, which is associated with the DocumentReference Resource, or in Document Sharing nomenclature, the author of the Document Entry. See ITI TF-2x: Appendix Z.2 for use of the string data type. This use of author.given and author.family follows the FHIR Chaining Parameters search methodology.

- `category`: This parameter, of type token, specifies the general classification of the DocumentReference Resource, or in Document Sharing nomenclature, the classCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `event`: This parameter, of type token, specifies the main clinical acts documented by the DocumentReference Resource, or in Document Sharing nomenclature, the eventCodeList of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `facility`: This parameter, of type token, specifies the kind of facility found in DocumentReference.context.facilityType, or in Document Sharing nomenclature, the healthcareFacilityTypeCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `format`: This parameter, of type token, specifies the format of the DocumentReference Resource, or in Document Sharing nomenclature, the formatCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `security-label`: This parameter, of type token, specifies the security labels of the document referenced by DocumentReference Resource, or in Document Sharing nomenclature, the confidentialityCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `setting`: This parameter, of type token, specifies the specific practice setting of the DocumentReference Resource, or in Document Sharing nomenclature, the practiceSettingCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `type`: This parameter, of type token, specifies the specific type of the DocumentReference resource or in Document Sharing nomenclature, the typeCode of the Document Entry. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `status`: This parameter, of type token, specifies the status of the DocumentReference Resource, or in Document Sharing nomenclature, the availabilityStatus of the Document Entry. The Document Consumer shall populate the identifier portion of the token using one of the short codes in Table 2:3.67.4.1.2.1-1. The system portion of the token shall not be populated.

With the exception of status, all parameters may be multi-valued.

The canonical URL to this Subscription Topic that shall be used in the `Subscription.criteria` element shall be `urn:uuid:742790e0-aba6-43d6-9f1fe43ed9790b79`.

The Resource Notification Broker shall determine if there is a Subscription which matches any of the DocumentReference resources in an event. The evaluation should be performed likely a search operation using the criteria in the Subscription. If matches, the Resource Notification Broker shall send a [Event Notification]() (see [ITI-112](ITI-112.html) transaction). If the `Subscription.payload.content` includes resources, the DocumentReference resources shall be present.

A canonical instances of this Subscription Topic is reported here: [Multi-Patient DocumentReference Subscription Topic](#).


#### 3.110.8.2.1 Multi-Patient DocumentReference Subscription Subscription with Updates to document sharing resources option Topic

When supported the Updating events option, this Subscription Topic extends the [Multi-Patient DocumentReference Subscriptions Topic](#311082-multi-patient-documentreference-subscriptions-topic) in this way:

- the stream of events for which subscriptions are possible **includes** alse events representing the **update or deletion** of DocumentReference Resources related to Documents. Note that these events could be deteminated by Document Entry Objects update or deletion in XDS enviroment.

The canonical URL to this Subscription Topic that shall be used in the `Subscription.criteria` element shall be `TO DEFINE`.

A canonical instances of this Subscription Topic are reported here: [Multi-Patient DocumentReference Subscription Subscription with Updates to document sharing resources option Topic]().

<a name="Patient-Dependent Folder Subscription Topic"> </a>

### 3.110.8.3 Patient-Dependent Folder Subscription Topic

For this type of subscription, the stream of events for which subscriptions are possible is limited to events representing the **creation or update** of Folder type List Resources related to Folders. Note that these events could be deteminated from Folder Objects creation or update in XDS enviroment. Note that these creation or updating events could be happened with other events.

For this type of subscription, the possible subscription criteria parmeters are:

- `code`: This parameter, of type token, specifies the code.coding value supplied in the List Resource. This parameter shall be used and the value of the code element shall indicates the List of type Folder.

- `patient`: This parameter is of type Reference(Patient). The Document Consumer may get this reference through the use of the PDQm or PIXm Profiles, or by some other method. When the patient parameter is used, the Patient reference would need to be accessible to both the Resource Notification Subscriber and the Resource Notification Broker.

- `patient.identifier`: This parameter, of type token, specifies an identifier associated with the patient to which the List Resource is assigned. See ITI TF-2x: Appendix Z.2 for use of the token data type for identifiers. This use of patient.identifier follows the FHIR Chaining Parameters search methodology.

- `identifier`: This parameter, of type token, specifies an identifier for this List. The search results represent the results of a search on List.identifier. See ITI TF-2x: Appendix Z.2 for additional constraints on the use of the token search parameter type.

- `designationType`: This IHE extension on parameters defined as List-DesignationType, of type token, specifies the designation type of the List. The value of the designation type element expresses contentType of submissionSet or the codeList of a Folder. Usually expressed in LOINC or SNOMED.

- `status`: This parameter, of type token, specifies the status of the List. If included in the query, the Document Consumer shall populate the code portion of the token, the system portion of the token shall not be populated. See Table 2:3.66.4.1.3.1-3: Values for status of List for mapping to XDS on FHIR Option.

At least one of the patient or patient.identifier parameter shall be used.

Only the identifier and designationType parameters may be multi-valued.

The canonical URL to this Subscription Topic that shall be used in the `Subscription.criteria` element shall be `urn:uuid:9376254e-da05-41f5-9af3-ac56d63d8ebd`.

The Resource Notification Broker shall determine if there is a Subscription which matches any of the Folder type List resources in an event. The evaluation should be performed likely a search operation using the criteria in the Subscription. If matches, the Resource Notification Broker shall send a [Event Notification]() (see [ITI-112](ITI-112.html) transaction). If the `Subscription.payload.content` includes resources, the Folder type List resources shall be present.

A canonical instances of this Subscription Topic is reported here: [Patient-Dependent Folder Subscription Topic](#).

#### 3.110.8.3.1 Patient-Dependent Folder Subscription Subscription with Updates to document sharing resources option Topic

When supported the Updating events option, this Subscription Topic extends the [Patient-Dependent Folder Subscription Topic](#311083-patient-dependent-folder-subscription-topic) in this way:

- the stream of events for which subscriptions are possible includes alse events representing the **deletion** of Folder type List Resources related to Folders. Note that these events could be deteminated from Folder Objects deletion in XDS enviroment.

The canonical URL to this Subscription Topic that shall be used in the `Subscription.criteria` element shall be `TO DEFINE`.

A canonical instances of this Subscription Topic are reported here: [Patient-Dependent Folder Subscription Subscription with Updates to document sharing resources option Topic]().

<a name="Patient-Dependent SubmissionSet Subscription Topic"> </a>

### 3.110.8.4 Patient-Dependent SubmissionSet Subscription Topic

For this type of subscription, the stream of events for which subscriptions are possible is limited to events representing the **creation** of SubmissionSet type List Resources related to SubmissionSet. Note that these events could be deteminated from SubmissionSet Objects creation in XDS enviroment. Note that these creation events could be happened with other events.

For this type of subscription, the possible subscription criteria parmeters are:

- `code`: This parameter, of type token, specifies the code.coding value supplied in the List Resource. This parameter shall be used and the value of the code element shall indicates the List of type SubmissionSet.

- `patient`: This parameter is of type Reference(Patient). The Document Consumer may get this reference through the use of the PDQm or PIXm Profiles, or by some other method. When the patient parameter is used, the Patient reference would need to be accessible to both the Resource Notification Subscriber and the Resource Notification Broker.

- `patient.identifier`: This parameter, of type token, specifies an identifier associated with the patient to which the List Resource is assigned. See ITI TF-2x: Appendix Z.2 for use of the token data type for identifiers. This use of patient.identifier follows the FHIR Chaining Parameters search methodology.

- `source.given` and `source.family`: These parameters, of type string, specify the name parts of the author person which is associated with the List. See ITI TF-2x: Appendix Z.2 for use of the string data type. This use of source.given and source.family follows the FHIR Chaining Parameters search methodology.

- `sourceId`: This IHE extension on parameters defined as List-SourceId, of type token, specifies the source (author) value supplied in the List Resource.

- `intendedRecipient` : This IHE extension on parameters defined as List-IntendedRecipient, of type token, specifies the IntendedRecipient of the List Resource.

At least one of the patient or patient.identifier parameter shall be used.

Only the source.given, source.family, sourceId and intendedRecipient parameters may be multi-valued.

The canonical URL to this Subscription Topic that shall be used in the `Subscription.criteria` element shall be `urn:uuid:fbede94e-dbdc-4f6b-bc1f-d730e677cece`.

The Resource Notification Broker shall determine if there is a Subscription which matches any of the SubmissionSet type List resources in an event. The evaluation should be performed likely a search operation using the criteria in the Subscription. If matches, the Resource Notification Broker shall send a [Event Notification]() (see [ITI-112](ITI-112.html) transaction). If the `Subscription.payload.content` includes resources, the SubmissionSet type List resources shall be present.

A canonical instances of this Subscription Topic is reported here: [Patient-Dependent SubmissionSet Subscription Topic](#).

<a name="Multi-Patient SubmissionSet Subscription Topic"> </a>

### 3.110.8.5 Multi-Patient SubmissionSet Subscription Topic

For this type of subscription, the stream of events for which subscriptions are possible is limited to events representing the **creation** of SubmissionSet type List Resources related to SubmissionSet. Note that these events could be deteminated from SubmissionSet Objects creation in XDS enviroment. Note that these creation events could be happened with other events.

For this type of subscription, the possible subscription criteria parmeters are:

- `code`: This parameter, of type token, specifies the code.coding value supplied in the List Resource. This parameter shall be used and the value of the code element shall indicates the List of type SubmissionSet.

- `source.given` and `source.family`: These parameters, of type string, specify the name parts of the author person which is associated with the List. See ITI TF-2x: Appendix Z.2 for use of the string data type. This use of source.given and source.family follows the FHIR Chaining Parameters search methodology.

- `sourceId`: This IHE extension on parameters defined as List-SourceId, of type token, specifies the source (author) value supplied in the List Resource.

- `intendedRecipient` : This IHE extension on parameters defined as List-IntendedRecipient, of type token, specifies the IntendedRecipient of the List Resource.

All the parameters may be multi-valued.

The canonical URL to this Subscription Topic that shall be used in the `Subscription.criteria` element shall be `urn:uuid:868cad3d-ec09-4565-b66c-1be10d034399`.

The Resource Notification Broker shall determine if there is a Subscription which matches any of the SubmissionSet type List resources in an event. The evaluation should be performed likely a search operation using the criteria in the Subscription. If matches, the Resource Notification Broker shall send a [Event Notification]() (see [ITI-112](ITI-112.html) transaction). If the `Subscription.payload.content` includes resources, the SubmissionSet type List resources shall be present.

A canonical instances of this Subscription Topic is reported here: [Multi-Patient SubmissionSet Subscription Topic](#).


## 3.110.9 Mapping between DSUBm Criteria and DSUB subscription Filters. 
If the Resource Notification Broker is grouped with Document Metadata Subscriber and Document Metadata Notification Recipient, considering [DSUBm as an interface for DSUB](volume-1.html#154631-dsubm-as-an-interface-for-dsub) model, the `Subscription.criteria` available parameters in the Subscription resource shall be mapped with the DSUB filter Expression. 

<a name="table-docRef"> </a>

**Table 3.110.9-1: DSUBm DocumentReference susbcription criteria mapping to DSUB DocumentEntry Filters**

| **DSUBm<br>Subscription.criteria** 	| **DSUB <br>DocumentEntry Filters**      	|
|------------------------------------------------	|---------------------------------------------	|
| author.given / author.family                   	| $XDSDocumentEntryAuthorPerson               	|
| category                                       	| $XDSDocumentEntryClassCode                  	|
| event                                          	| $XDSDocumentEntryEventCodeList              	|
| facility                                       	| $XDSDocumentEntryHealthcareFacilityTypeCode 	|
| format                                         	| $XDSDocumentEntryFormatCode                 	|
| patient or patient.identifier                  	| $XDSDocumentEntryPatientId                  	|
| security-label                                 	| $XDSDocumentEntryConfidentialityCode        	|
| type                                           	| $XDSDocumentEntryTypeCode                   	|
| status                                         	| none                                        	|
{: .grid}

<a name="table-folder"> </a>

**Table 3.110.9-2: DSUBm Folder susbcription criteria mapping to DSUB DocumentEntry Filters**

| **DSUBm<br>Subscription.criteria** |    **DSUB <br>Folder Filters**   |
|------------------------------------------------|---------------------------------------------|
| code                                           | none             |
| patient or patient.identifier                  | $XDSFolderPatientId                 |
| identifier                                     | $XDSFolderUniqueId              |
| designationType                                | $XDSFolderCodeList |
| status                                         | none                                        |
{: .grid}

<a name="table-submiss"> </a>

**Table 3.110.9-3: DSUBm SubmissionSet susbcription criteria mapping to DSUB DocumentEntry Filters**

| **DSUBm<br>Subscription.criteria** |    **DSUB <br>SubmissionSet Filters**   |
|------------------------------------------------|---------------------------------------------|
| code                                           | none               |
| patient or patient.identifier                  | $XDSSubmissionSetPatientId                  |
| source.given or source.family                  | $XDSSubmissionSetAuthorPerson              |
| sourceId                                       | $XDSSubmissionSetSourceId              |
| intendedRecipient                              | $XDSSubmissionSetIntendedRecipient |
{: .grid}


 
## 3.110.10 CapabilityStatement Resource

The Resource Notification Broker implementing this transaction shall provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [broker](CapabilityStatement-IHE.DSUBm.client.html)

The Resource Notification Subscriber implementing this transaction shall provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [suscriber](CapabilityStatement-IHE.DSUBm.client.html)

<a name="security_ITI-110"> </a>

## 3.110.11 Security Considerations 
See [DSUBm Security Considerations](volume-1.html#security-considerations). 

The Resource Notification Broker shall control that the Resource Notification Subscriber is acceptable and authorised to create/update a Subscription Resource. It's highly recommended that the Resource Notification Subscriber should use some form of authentication method when creating or updating a Subscription.
The Resource Notification Broker shall also be aware and enforce any agreed policy in order to control that the Subscription criteria received, that describe the notification event, are permitted to the authenticated Resource Notification Subscriber. For example a veterinary clinical record may be allowed to reqeust for subscription but the Resource Notification Broker shall verify that the Subscription is relataed only to documents produced for animal subjects and shall reject any subscription made for documents produced for human subjects. 

The Resource Notification Broker might maintain a whitelist of acceptable senders for the rest-create/rest-update methods. 
The Resource Notification Broker may enforce some control on `channel.endpoint` element of Subscription resource received in order to control where the notification will be sent. The Resource Notification Broker might maintain a allow-list of acceptable endpoints or trusted certificate authorities for rest-hook channels.
The Resource Notification Broker may control the `Subscription.payload` element of Subscription resource received in order to mitigate the risk of disclosing sensitive information. For example, if the Subscription criteria includes sensitive documents, the Resource Notification Broker may allow just 'id-only' payloads. In this way further authorization mechanism shall be enforced when the Resource Notification Recipient tries to recover the information using the id. 

### 3.110.11.1 Security Audit Considerations

The Resource Notification Subscriber, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record a [Create Subscription Subscriber Audit Event Log](StructureDefinition-IHE.DSUBm.CreateSubscription.Audit.Subscriber.html) and a [Update Subscription Subscriber Audit Event Log](StructureDefinition-IHE.DSUBm.UpdateSubscription.Audit.Subscriber.html). !!! TO DO ARTIFACT !!!!

The Resource Notification Broker, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record a [Create Subscription Broker Audit Event Log](StructureDefinition-IHE.DSUBm.CreateSubscription.Audit.Broker.html) and a [Update Subscription Broker Audit Event Log](StructureDefinition-IHE.DSUBm.UpdateSubscription.Audit.Broker.html). !!! TO DO ARTIFACT !!!!


The Resource Notification Subscriber and Resource Notification Broker may also record fundamental AuditEvents for each individual resource Created or Updated, using the [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [basic profile for REST events](https://profiles.ihe.net/ITI/BALP/content.html#3573-restful-activities).


