This section corresponds to transaction [ITI-111] Resource Publish of the IHE Technical Framework. The [ITI-111] Resource Publish is used by the Resource Notification Publisher and Resource Notification Broker Actors. This transaction is used to communicate an event about Documents. 

### 3.111.1 Scope

The [ITI-111] Resource Publish transaction delivers information from the Resource Notification Publisher to the Resource Notification Broker about an event regarding Documents. These information can be evaluated by the Resource Notification Broker against the Subscription received and may trigger a notification. 

### 3.111.2 Actors Roles

**Table: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Publisher](volume-1.html#publisher)    | Publishes information to the Resource Notification Broker when applicable events occur about Documents for which a subscription may exist |
| [Resource Notification Broker](volume-1.html#broker) | Receives and processes information about events for which there may be a subscription |
{: .grid}

### 3.111.3 Referenced Standards

**FHIR-R4** [HL7 FHIR Release 4.0.](https://www.hl7.org/FHIR/R4)

### 3.111.4 Interactions

<figure>
{%include ITI-111-Publish-seq.svg%}
<figcaption><b>Figure 2:3.111: ITI-111 interactions</b></figcaption>
</figure>
<br clear="all">

#### 3.111.5 Resource Publish Request Message
This method uses an HTTP POST method on the target Resource Notification Broker endpoint to communicate a publication event that may have a subscription.

##### 3.111.5.1 Trigger Events

When an event occurs for which a subscription may exist, the Resource Notification Publisher will trigger a Resource Publish Request message to the Resource Notification Broker. 
Events that could trigger a notification are:
- regarding MHD domain: 
    - publication of or update to a DocumentReference resource, Folder type List resource or SubmissionSet type List resource;
- regarding XDS domain: 
    - publication of or update to a DocumentEntry, Folder or SubmissionSet
    - update of DocumentEntry Metadata or Folder Metadata
    - only the update of DocumentEntry Status or Folder availabilityStatus to "Approved"

##### 3.111.5.2 Message Semantics

The Resource Notification Publisher shall initiate a FHIR "transaction" using a "create" action by sending an HTTP POST request method composed of a FHIR Bundle Resource containing: one `SubmissionSet type List Resource`;  zero or more `DocumentReference Resources`; zero or more `Folder type List Resources`. 

The Bundle resource shall contain all the FHIR resources related to the event that has occured in the `Bundle.entry` elements.

The media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml`.

See [http://hl7.org/fhir/R4/http.html#transaction](http://hl7.org/fhir/R4/http.html#transaction) for complete requirements of a transaction. See [http://hl7.org/fhir/R4/bundle-transaction.html](http://hl7.org/fhir/R4/bundle-transaction.html) for example of a transaction bundle.

The Provide Document Bundle message is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4/http.html](http://hl7.org/fhir/R4/http.html) for the definition of “HTTP” access methods and “base”.

###### 3.111.5.2.1 Bundle resource

For complete information on constructing a FHIR Bundle Resource, see [http://hl7.org/fhir/R4/bundle.html](http://hl7.org/fhir/R4/bundle.html).

The FHIR Bundle shall have the following constrains:

 - [Publishing Bundle]()<!--link-->:
    - shall be a Transaction Bundle
    - all resources shall be compliant with minimal constraints
    - shall create a [SubmissionSet type List]()<!--link-->
    - may create one or more [DocumentReference]()<!--link-->
    - may create one or more [Folder type List]()<!--link-->
    - may create one [Patient]() <!--link-->
<!-- also consider the read operation ?-->

The Resource Notification Publisher shall construct these resources:
- from SubmissionSet type List, DocumentReference, Folder type List resource of MHD domain, mantaining all the elements; also the contained resourced shall be mantained using the FHIR contained method (see [http://hl7.org/fhir/R4/references.html#contained](http://hl7.org/fhir/R4/references.html#contained));
- from SubmissionSet, Folder, and DocumentEntry objects from the RegistryObject elements of XDS domain, mapping all the elements (metadata); <!--link to the mapping--> in this case, the resource referenced in DocumentReference.author, DocumentReference.authenticator, DocumentReference.context.sourcePatientInfo and List.source must be sent as contained resources.

All DocumentReference.subject and List.subject values shall be populated with the identity of the Patient.

###### 3.111.5.2.2 Patient Identity

All DocumentReference.subject, and List.subject values shall be a Reference to a FHIR Patient Resource. The Patient Reference will be either to a Patient Resource that is in the Bundle, or to a Patient Resource hosted on a commonly accessible server. Recommendation is to use a commonly accessible Patient Resource reference, but some situations may need to include the Patient resource within the Bundle, or may allow use of a common Patient Identifier. This could be depend also on the sharing documents infrastructure implemented.

- A Patient Reference to a commonly accessible server may be obtained through use of [PDQm](https://profiles.ihe.net/ITI/TF/Volume1/ch-38.html), [PIXm](https://profiles.ihe.net/ITI/TF/Volume1/ch-41.html), [PMIR](https://profiles.ihe.net/ITI/TF/Volume1/ch-49.html), or by some other means.
- The inclusion of a copy of a commonly accessible Patient Resource in the bundle is discouraged but not forbidden.
- A commonly accessible logical reference using Patient Identifier, instead of a literal reference, may be acceptable where there is a common Identifier, such as a national individual identifier.

If the Patient Resource is accessible to both the Resource Notification Publisher and Resource Notification Broker via an external reference to a commonly accessible server then that external reference shall be used and the Patient Resource will not be included in the Bundle. Otherwise, the Patient Resource shall be included in the Bundle.

##### 3.111.5.3 Expected Actions

The Resource Notification Broker shall accept both media types application/fhir+json and application/fhir+xml.

The Resource Notification Broker shall process the bundle atomically as specified in http://hl7.org/fhir/R4/http.html#transaction.

The Resource Notification Broker shall validate the bundle first against the FHIR specification. Guidance on what FHIR considers a valid Resource can be found at http://hl7.org/fhir/R4/validation.html.

If necessary for processing, the Resource Notification Broker shall retrieve Resources referenced by absolute URLs in the FHIR Bundle Resource.

If the Resource Notification Broker validations failed, the Resource Notification Broker shall return an error, as documented in [Resource Publish Response Message](). 

If the validation of the Resource Publish Request Message is completed and if there are matching subscriptions, the Resource Notification Broker shall send the corresponding Resource Notify [ITI-112] transaction to the appropriate Resource Notification Recipient.

#### 3.111.6 Resource Publish Response Message

The Resource Notification Broker sends a Resource Publish Response Message to respond to a Resource Publish Request Message.

##### 3.111.6.1 Trigger Events

The Resource Notification Broker has received a Resource Publish Request Message.

##### 3.111.6.2 Message Semantics

The Resource Notification Broker shall return a Bundle, with `type` set to `transaction-response`, that contains one entry for each entry in the request, in the same order as received, with the Bundle.entry.response.outcome indicating the results of processing the entry. TheResource Notification Broker shall comply with FHIR [http://hl7.org/fhir/R4/bundle.html#transaction-response](http://hl7.org/fhir/R4/bundle.html#transaction-response) and [http://hl7.org/fhir/R4/http.html#transaction-response](http://hl7.org/fhir/R4/http.html#transaction-response).

To indicate success the overall http 200 response is used. The Bundle.entry.response.status shall be 201 to indicate the Resource has been created and the .location element shall be populated.

##### 3.111.6.3 Expected Actions

The Resource Notification Publisher processes the results according to application-defined rules.

### 3.111.7 CapabilityStatement Resource
The Resource Notification Broker implementing this transaction shall provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [broker](CapabilityStatement-IHE.DSUBm.client.html)

The Resource Notification Subscriber implementing this transaction shall provide a CapabilityStatement Resource as described in [ITI TF-2x: Appendix Z.3](https://profiles.ihe.net/ITI/TF/Volume2/ch-Z.html#z.3-capabilitystatement-resource) indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [publisher](CapabilityStatement-IHE.DSUBm.client.html)

### 3.111.8 Security Considerations

See [DSUBm Security Considerations](volume-1.html#security-considerations). 

It's highly recommended that the Resource Notification Publisher should use some form of authentication method when sending the Resource Publish Request Message. The Resource Notification Broker should always verify the authentication token used in this transaction before considering the message received.  

#### 3.111.8.1 Security Audit Considerations

''TODO: The security audit criteria ''

##### 3.111.8.1.1 Client Audit 

''TODO: the specifics''

##### 3.111.8.1.2 Server Audit 

''TODO: the specifics''
