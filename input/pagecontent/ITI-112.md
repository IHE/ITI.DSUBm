This section corresponds to transaction [ITI-112] Resource Notify of the IHE Technical Framework. Transaction [ITI-112] Resource Notify is used by the Resource Notification Broker and Resource Notification Recipient.

### 3.112.1 Scope Scope

This transaction 
The Resource Notify [ITI-112] transaction delivers a notification from the Resource Notification Broker to the Resource Notification Recipient about an event which matches an existing subscription.

### 3.112.2 Actors Roles

**Table: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Broker](volume-1.html#broker)    | Sends the Notification Bundle Request to the Resource Notification Recipient |
| [Resource Notification Recipient](volume-1.html#recipient) | Receives the notification |
{: .grid}

### 3.112.3 Referenced Standards

**FHIR-R4** [HL7 FHIR Release 4.0.](https://www.hl7.org/FHIR/R4)

### 3.112.4 Interactions

<figure>
{%include ITI-112-Notification-seq.svg%}
<figcaption><b>Figure 2:3.112: ITI-112 interactions</b></figcaption>
</figure>
<br clear="all">


#### 3.112.5 Notification Bundle Request
This message uses the HTTP POST method on the target Resource Notification Recipient endpoint to submit the notification.

##### 3.112.5.1 Trigger Events
When an event occurs where the topics of the event match the filter requirements of one or more existing subscriptions, the Resource Notification Broker will trigger a Notification message to the corresponding Resource Notification Recipient.

##### 3.112.5.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4/http.html#create)” interaction. The message uses an HTTP POST method to submit a Bundle FHIR Resource as specify in [3.112.5.2.1 Bundle Resource]()<!--link-->.

The Resource Notification Subscriber actor shall submit the FHIR Bundle resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.Th format shall match the MIME type on the `Subscription.channel.payload` element.

The Bundle is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4/http.html](https://hl7.org/fhir/R4/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol.

##### 3.112.5.2.1 Bundle Resource

 The Bundle resource shall be compliant with [Bundle](https://hl7.org/fhir/R4/Bundle.html) and shall support the [R4 Topic-Based Subscription Notification Bundle](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-subscription-notification.html).

 The FHIR Bundle shall have the following constrains:
 
 - the `Bundle.type` element shall be `history`
 - the first entry shall be a Element resource, compliant with [R4 Backported R5 SubscriptionStatus](). This element is necessary to describe during notifications the state of the Subscription that has been triggered.
 - zero or more additional entries, with either URLs or resources representing contents, may be present, depending on the `Subscription.payload`
 
 
 Note that since notifications use history type Bundles, all notifications need to comply with the requirements for that bundle type. Specifically, there are two invariants on Bundle (bdl-3 and bdl-4) that require a Bundle.entry.request element for every Bundle.entry.
 
 - For the status resource (entry[0]), the request SHALL be filled out to match a request to the $status operation.
 - For additional entries, the request SHOULD be filled out in a way that makes sense given the subscription (e.g., a POST or PUT operation on the resource, etc.). However, a server MAY choose to simply include a GET to the relevant resource instead.

###### 3.112.5.2.1.1 Event Notification

The Bundle Resource sended by the Resource Notification Broker when an event occurs shall have:

- [Event Notification]()<!--link-->
    - the `Bundle.type` element valued `history`
    - in the first the first entry the [Notification Subscription Status Element]()<!--link--> resource;
    - zero or more additional entries, with either URLs or resources representing contents, depending on the `Subscription.payload.content` and the `notificationShape` defined in the Topic of the Subscription

The payload content extension defines three types of payload: 

- `empty` = No resource content is transmitted in the notification payload. 
- `id-only` = Only the resource id is transmitted in the notification payload.
- `full-resource` = The entire resource is transmitted in the notification payload.

When the payload content includes theresources, the notification shape shall be based on the definitions from the Topic of the Subscription:

- the resource that is the trigger for the Topic shall be included by the Resource Notification Broker
- any other resorce may be included by the Resource Notification Broker; in order to include resource that could be of interest for the Resource Notification Recipient, the Resource Notification Broker should follow what is define by the Topic of the Subscription for the notification shape. 

Note that Resource Notification Broker SHOULD attempt to provide the resources described in the topic, however Resource Notification Recipient SHALL expect that any resource beyond the focus resource are not guaranteed to be present.

###### 3.112.5.2.1.2 Handshake Notification

The Bundle Resource sended by the Resource Notification Broker when an event occurs shall have:

- [Handshake Notification]()<!--link-->
    - the `Bundle.type` element valued `history`
    - in the first the first entry the [Handshake Subscription Status Element]()<!--link--> resource.

###### 3.112.5.2.1.3 Heartbeat Notification

The Bundle Resource sended by the Resource Notification Broker when an event occurs shall have:

- [Heartbeat Notification]()<!--link-->
    - the `Bundle.type` element valued `history`
    - in the first the first entry the [Heartbeat Subscription Status Element]()<!--link--> resource;


##### 3.112.5.3 Expected Actions

The Resource Notification Recipient processes the results according to application-defined rules.
The Resource Notification Recipient may handle errors if detected.

#### 3.112.6 Notification Bundle Response

The Resource Notification Recipient sends a Notification Bundle Response message to respond to a Notification Bundle Request message.

##### 3.112.6.1 Trigger Events

When the Resource Notification Recipient receives the notification sends this message to the Resource Notification Broker acknowledging the reception of the notification.

##### 3.112.6.2 Message Semantics

When the Resource Notification Recipient has processed the request, it shall return an HTTP response with an overall status code.

The Resource Notification Recipient returns an HTTP status code appropriate to the processing of the create request. If the notification has been received and processed the Resource Notification Recipient shall respond with an `HTTP 201 Created` status code as indicated in https://hl7.org/fhir/R4B/http.html#create.Otherwise, if the reception or processing of the notification has failed the Resource Notification Recipient shall respond with `HTTP 400 Bad Request`.


##### 3.112.6.3 Expected Actions

The Resource Notification Recipient may handle errors like missed notifications and broken connections by using the $event and $status operations on the transaction Resource Subscription Search [ITI-113] as defined [here](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/errors.html#handling-errors).


### 3.112.6.4 CapabilityStatement Resource

The Server implementing this transaction shall provide a CapabilityStatement Resource as described in ITI TF-2x: Appendix Z.3 indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [Client](CapabilityStatement-IHE.ToDo.client.html)
* Requirements CapabilityStatement for [Server](CapabilityStatement-IHE.ToDo.server.html)

### 3.112.6.5 Security Considerations

See [DSUBm Security Considerations](volume-1.html#security-considerations). 

The Resource Notification Broker should confirm that the Resource Notification Recipient is still authorized to receive the information that it is searching for. If Authorization Token is used to verify the autorization of a Recipient to receive notification the Resource Notification Broker shall also verify that this tokens has not been revoked before sending the Notification Bundle Request message. 

It's highly recommended that the Resource Notification Broker should use some form of authentication method when sending a notification Message and the Resource Notification Recipient should always verify the authentication token used in this transaction. 

The Resource Notification Recipient should also be defensive and robust to a malicious client that may send a large volume of fake notifications with empty notifications, which would cause the Resource Notification Recipient to send many (potentially expensive) queries to a server.



#### 3.112.6.6 Security Audit Considerations

The Resource Notification Broker, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record a [Notify Broker Audit Event Log](StructureDefinition-IHE.DSUBm.Notify.Audit.Broker.html).  !!! TO DO ARTIFACT !!!!

The Resource Notification Recipient, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record a [Notify Recipient Audit Event Log](StructureDefinition-IHE.DSUBm.Notify.Audit.Recipient.html).  !!! TO DO ARTIFACT !!!!

The Resource Notification Broker and Resource Notification Recipient may also record fundamental AuditEvents for each individual resource Created or Updated, using the [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [basic profile for REST events](https://profiles.ihe.net/ITI/BALP/content.html#3573-restful-activities).
