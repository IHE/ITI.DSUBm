This section corresponds to Resource Notify [ITI-112] transaction of the IHE Technical Framework. The Resource Notify [ITI-112] transaction is used by the Resource Notification Broker and Resource Notification Recipient.

### 3.112.1 Scope

The Resource Notify [ITI-112] transaction delivers a notification from the Resource Notification Broker to the Resource Notification Recipient about an event which matches an existing subscription.

The notifications from the Resource Notification Broker also include the Handshake Notification and the Heartbeat Notification in order to verify the recheability of the Resource Notification Recipient in the subscription activation process and during the existance of the subscription itself. Further, the Subscription Deactivation Notification can be send to inform about the deactivation of the Subscription.

### 3.112.2 Actors Roles

**Table: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Broker](volume-1.html#broker)    | Sends the Notification Bundle Request to the Resource Notification Recipient |
| [Resource Notification Recipient](volume-1.html#recipient) | Receives the notification |
{: .grid}

### 3.112.3 Referenced Standards

**FHIR-R4B** [HL7 FHIR Release 4.3.0](https://www.hl7.org/FHIR/R4B)

### 3.112.4 Interactions

<figure>
{%include ITI-112-Notification-seq.svg%}
<figcaption><b>Figure 2:3.112: ITI-112 interactions</b></figcaption>
</figure>
<br clear="all">

<!-- handshake-->
#### 3.112.5 Handshake Notification Message
This message uses the HTTP POST method on the target Resource Notification Recipient endpoint to submit the Handshake Notification.

##### 3.112.5.1 Trigger Events
In order to verify the recheability of the Resource Notification Recipient in the subscription activation process, after receiving a [Create Subscription Request Message [ITI-110]](ITI-110.html#31105-create-subscription-request-message), the Resource Notification Broker will trigger this message to the corresponding Resource Notification Recipient.

##### 3.112.5.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4B/http.html#create)” interaction. The message uses an HTTP POST method to submit a Bundle FHIR Resource. 

The Bundle resource shall be compliant with [Bundle](https://hl7.org/fhir/R4B/Bundle.html) and shall be compliant with [R4 Topic-Based Subscription Notification Bundle](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-subscription-notification.html).

The Resource Notification Subscriber actor shall submit the FHIR Bundle resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.Th format shall match the MIME type on the `Subscription.channel.payload` element.

The Bundle is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol. The HTTPS protocol is highly recommended.

The Bundle Resource sended by the Resource Notification Broker shall have:

- [Handshake Notification]()<!--link-->
    - the `Bundle.type` element valued `history`;
    - in the first entry the [Handshake Subscription Status]()<!--link--> resource and the `request` element shall be filled out to match a request to the $status operation;
    - no other entry shall be present.


##### 3.112.5.3 Expected Actions

The Resource Notification Recipient processes the message according to application-defined rules and produces an [Handshake Notification Response](#31129-handshake-notification-response).

If the Resource Notification Broker has not been able to send the [Handshake Notification Message](#31125-handshake-notification-message) because of connection problem, it shall deactivate the Subscription, setting the `Subscription.status=error`.

If the Resource Notification Broker has been able to send the Handshake Notification Message but it has not received any [Handshake Notification Response](#31129-handshake-notification-response) from the Resource Notification Recipient, it shall deactivate the Subscription, setting the `Subscription.status=error`.


<!-- heartbeat-->
#### 3.112.6 Heartbeat Notification Message
This message uses the HTTP POST method on the target Resource Notification Recipient endpoint to submit the Heartbeat Notification in order to verify the recheability of the Resource Notification Recipient.

##### 3.112.6.1 Trigger Events
In order to verify the recheability of the Resource Notification Recipient during the existance of the Subscription, after its activation, the Resource Notification Broker will trigger this message to the corresponding Resource Notification Recipient. If in the Subscription the `heartbeatPeriod` element is evaluated, the Resource Notification Broker shall attempt to send an Heartbeat Notification Message after each interval express in that element.

##### 3.112.6.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4B/http.html#create)” interaction. The message uses an HTTP POST method to submit a Bundle FHIR Resource. 

The Bundle resource shall be compliant with [Bundle](https://hl7.org/fhir/R4B/Bundle.html) and shall be compliant with [R4 Topic-Based Subscription Notification Bundle](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-subscription-notification.html).

The Resource Notification Subscriber actor shall submit the FHIR Bundle resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.Th format shall match the MIME type on the `Subscription.channel.payload` element.

The Bundle is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol. The HTTPS protocol is highly recommended.

The Bundle Resource sended by the Resource Notification Broker shall have:

- [Heartbeat Notification]()<!--link-->
    - the `Bundle.type` element valued `history`;
    - in the first the [Heartbeat Subscription Status]()<!--link--> resource and the `request` element shall be filled out to match a request to the $status operation;
    - no other entry shall be present.    
    

##### 3.112.6.3 Expected Actions

The Resource Notification Recipient processes the message according to application-defined rules and produces an [Hearthbeat Notification Response](#311210-hearthbeat-notification-response).

If the Resource Notification Broker has not been able to send the [Hearthbeat Notification Message](#31126-heartbeat-notification-message) because of connection problem, it shall deactivate the Subscription, setting the `Subscription.status=error`.

If the Resource Notification Broker has been able to send the Handshake Notification Message but it has not received any [Hearthbeat Notification Message](#31126-heartbeat-notification-message) from the Resource Notification Recipient, it shall deactivate the Subscription, setting the `Subscription.status=error`.

If the Resource Notification Recipient is grouped with the Resource Notification Subscriber, the Resource Notification Subscriber may handle errors or broken connections by using the $events and $status operations on the transaction Resource Subscription Search [ITI-113] and following what is define in [Detecting Errors as a Subscriber](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/errors.html#detecting-errors-as-a-subscriber), [Broken Communication](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/errors.html#broken-communication) and [Recovering from Errors](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/errors.html#recovering-from-errors) sections of the [Subscriptions R5 Backport](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/index.html).

<!-- event-->
#### 3.112.7 Event Notification Message
This message uses the HTTP POST method on the target Resource Notification Recipient endpoint to submit the Event Notification.

##### 3.112.7.1 Trigger Events
When an event occurs where the topics of the event match the filter requirements of one or more existing Subscriptions, the Resource Notification Broker shall trigger this message to the corresponding Resource Notification Recipient.

##### 3.112.7.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4B/http.html#create)” interaction. The message uses an HTTP POST method to submit a Bundle FHIR Resource. 

The Bundle resource shall be compliant with [Bundle](https://hl7.org/fhir/R4B/Bundle.html) and shall be compliant with [R4 Topic-Based Subscription Notification Bundle](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-subscription-notification.html).

The Resource Notification Subscriber actor shall submit the FHIR Bundle resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.Th format shall match the MIME type on the `Subscription.channel.payload` element.

The Bundle is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol. The HTTPS protocol is highly recommended.

The Bundle Resource sended by the Resource Notification Broker shall have:

- [Event Notification]()<!--link-->
    - the `Bundle.type` element valued `history`
    - in the first entry the [Notification Subscription Status]()<!--link--> resource and the `request` element shall be filled out to match a request to the $status operation;
    - zero or more additional entries, with either URLs or resources representing contents, depending on the `Subscription.payload.content` and the `notificationShape` defined in the Topic of the Subscription; for additional entries, the request should be filled out in a way that makes sense given the Subscription (e.g., a POST or PUT operation on the resource, matching the event happened to that resource that trigger the notification). However, a Resource Notification Broker may choose to simply include a GET to the relevant resource instead.

When the payload content includes the resources, the notification shape shall be based on the definitions from the Topic of the Subscription:

- the resource that is the trigger for the Topic shall be included by the Resource Notification Broker
- any other resorce may be included by the Resource Notification Broker; in order to include resource that could be of interest for the Resource Notification Recipient, the Resource Notification Broker should follow what is define by the Topic of the Subscription for the notification shape. 

Note that Resource Notification Broker should attempt to provide the resources described in the topic, however Resource Notification Recipient shall expect that any resource beyond the focus resource are not guaranteed to be present.


##### 3.112.7.3 Expected Actions

The Resource Notification Recipient processes the message according to application-defined rules and produces an [Event Notification Response](#311211-event-notification-response).

If the Resource Notification Broker has not been able to send the [Event Notification Message](#31127-event-notification-message) because of connection problem, it shall deactivate the Subscription, setting the `Subscription.status=error`.

If the Resource Notification Broker has been able to send the Handshake Notification Message but it has not received any [Event Notification Message](#31127-event-notification-message) from the Resource Notification Recipient, it shall deactivate the Subscription, setting the `Subscription.status=error`.

If the Resource Notification Recipient is grouped with the Resource Notification Subscriber, the Resource Notification Subscriber may handle errors like error or broken connection by using the $events and $status operations on the transaction Resource Subscription Search [ITI-113] and following what is define in [Detecting Errors as a Subscriber](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/errors.html#detecting-errors-as-a-subscriber), [Broken Communication](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/errors.html#broken-communication) and [Recovering from Errors](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/errors.html#recovering-from-errors) sections of the [Subscriptions R5 Backport](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/index.html).

<!-- deactivation-->
#### 3.112.8 Subscription Deactivation Notification Message
This message uses the HTTP POST method on the target Resource Notification Recipient endpoint to submit the notification.

##### 3.112.8.1 Trigger Events

When a Subscription deactivation occurs, performed by the Resource Notification Broker at the termination time or, with the [ITI-110] Resource Subscription transaction, by the same Resource Notification Subscriber that made the subscription or by another Resource Notification Subscriber, the Resource Notification Broker should trigger this message to the corresponding Resource Notification Recipient, in order to inform that the Subscription is no longer active.

##### 3.112.8.2 Message Semantics

The Resource Notification Subscriber shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4B/http.html#create)” interaction. The message uses an HTTP POST method to submit a Bundle FHIR Resource. 

The Bundle resource shall be compliant with [Bundle](https://hl7.org/fhir/R4B/Bundle.html) and shall be compliant with [R4 Topic-Based Subscription Notification Bundle](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-subscription-notification.html).

The Resource Notification Subscriber actor shall submit the FHIR Bundle resource in either XML format or JSON format thus the media type of the HTTP body shall be either `application/fhir+json` or `application/fhir+xml` respectively.Th format shall match the MIME type on the `Subscription.channel.payload` element.

The Bundle is sent to the base URL as defined in FHIR. See [http://hl7.org/fhir/R4B/http.html](https://hl7.org/fhir/R4B/http.html) for the definition of “HTTP” access methods and “base”.

It is possible to use HTTP protocol or HTTPS protocol. The HTTPS protocol is highly recommended.

The Bundle Resource sended by the Resource Notification Broker shall have:

- [Subscription Deactivation Notification]()<!--link-->
    - the `Bundle.type` element valued `history`;
    - in the first the [Deactivation Subscription Status]()<!--link--> resource and the `request` element shall be filled out to match a request to the $status operation;
    - no other entry shall be present.


##### 3.112.8.3 Expected Actions

The Resource Notification Recipient processes the message according to application-defined rules and produces an [Subscription Deactivation Response](#311212-subscription-deactivation-notification-response).

If the Resource Notification Recipient is grouped with the Resource Notification Subscriber, the Resource Notification Subscriber should be aware if this notifiation received is related to its own unsubscription or if it is related to an unsubscription performed by another Resource Notification Subscriber or it is related to deactivation performed by the Resource Notification Broker at the expiration time of the Subscription, and then proceeds according to its application-defined rules.

<!-- response 1-->

#### 3.112.9 Handshake Notification Response

The Resource Notification Recipient sends an Handshake Notification Response to respond to an [Handshake Notification Message](#31125-handshake-notification-message).

##### 3.112.9.1 Trigger Events

When the Resource Notification Recipient receives the [Handshake Notification Message](#31125-handshake-notification-message) from the Resource Notification Broker, it send this message to acknowledging the reception of the notification.

##### 3.112.9.2 Message Semantics

When the Resource Notification Recipient has processed the request, it shall return an HTTP response with an overall status code and produce a response that shall be conformed according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4B/http.html#create)” interaction. 


##### 3.112.9.3 Expected Actions
The Resource Notification Broker processes the message according to application-defined rules.

If the Resource Notification Broker receives a positive response, it shall activate the Subscription that trigger the handshake process, setting the `Subscription.status=active`. 

If the Resource Notification Broker receives a negative response (based on HTTP status or the OperationOutcome receives), the Resource Notification Broker it shall deactivate the Subscription that trigger the handshake process, setting the `Subscription.status=error`.

<!-- response 2-->

#### 3.112.10 Hearthbeat Notification Response

The Resource Notification Recipient sends an Hearthbeat Notification Response to respond to an [Hearthbeat Notification Message](#31126-heartbeat-notification-message).

##### 3.112.10.1 Trigger Events

When the Resource Notification Recipient receives the [Hearthbeat Notification Message](#31126-heartbeat-notification-message) from the Resource Notification Broker, it send this message to acknowledging the reception of the notification.

##### 3.112.10.2 Message Semantics

When the Resource Notification Recipient has processed the request, it shall return an HTTP response with an overall status code and produce a response that shall be conformed according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4B/http.html#create)” interaction. 

##### 3.112.10.3 Expected Actions

The Resource Notification Broker processes the message according to application-defined rules.

If the Resource Notification Broker receives a negative response (based on HTTP status or the OperationOutcome receives), the Resource Notification Broker it shall deactivate the Subscription that trigger the handshake process, setting the `Subscription.status=error`.

<!-- response 3-->

#### 3.112.11 Event Notification Response

The Resource Notification Recipient sends an Event Notification Response to respond to an [Event Notification Message](#31127-event-notification-message).

##### 3.112.11.1 Trigger Events

When the Resource Notification Recipient receives the [Event Notification Message](#31127-event-notification-message) from the Resource Notification Broker, it send this message to acknowledging the reception of the notification.

##### 3.112.11.2 Message Semantics

When the Resource Notification Recipient has processed the request, it shall return an HTTP response with an overall status code and produce a response that shall be conformed according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4B/http.html#create)” interaction. 


##### 3.112.11.3 Expected Actions
The Resource Notification Broker processes the message according to application-defined rules.

If the Resource Notification Broker receives a negative response (based on HTTP status or the OperationOutcome receives), the Resource Notification Broker it shall deactivate the Subscription that trigger the handshake process, setting the `Subscription.status=error`.

<!-- response 4-->

#### 3.112.12 Subscription Deactivation Notification Response

The Resource Notification Recipient sends an Event Notification Response to respond to an [Subscription Deactivation Message](#31128-subscription-deactivation-notification-message).

##### 3.112.12.1 Trigger Events

When the Resource Notification Recipient receives the [Subscription Deactivation Message](#31128-subscription-deactivation-notification-message) from the Resource Notification Broker, it send this message to acknowledging the reception of the notification.

##### 3.112.12.2 Message Semantics

When the Resource Notification Recipient has processed the request, it shall return an HTTP response with an overall status code and produce a response that shall be conformed according to requirements defined in the HL7® FHIR® standard for “[create](https://hl7.org/fhir/R4B/http.html#create)” interaction. 


##### 3.112.12.3 Expected Actions
The Resource Notification Broker processes the message according to application-defined rules.

### 3.112.13 CapabilityStatement Resource

The Server implementing this transaction shall provide a CapabilityStatement Resource as described in ITI TF-2x: Appendix Z.3 indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [Client](CapabilityStatement-IHE.ToDo.client.html)
* Requirements CapabilityStatement for [Server](CapabilityStatement-IHE.ToDo.server.html)

### 3.112.14 Security Considerations

See [DSUBm Security Considerations](volume-1.html#security-considerations). 

The Resource Notification Broker should confirm that the Resource Notification Recipient is still authorized to receive the information that it is searching for. To assess if a Resource Notification Recipient is still  authorized to receive the information the Resource Notification Broker may utilize additional policy defined between the actors in order to prevent the sending of notifications in particular cases. If an authorization token is used to verify the autorization of a Recipient to receive notification the Resource Notification Broker shall also verify that this tokens has not been revoked before sending the Notification Bundle Request message. 

It's highly recommended that the Resource Notification Broker should use some form of authentication method when sending a notification Message and the Resource Notification Recipient should always verify the authentication token used in this transaction. 

The Resource Notification Recipient should also be defensive and robust to a malicious client that may send a large volume of fake notifications with empty notifications, which would cause the Resource Notification Recipient to send many (potentially expensive) queries to a server.


#### 3.112.14.1 Security Audit Considerations

The Resource Notification Broker, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record fundamental AuditEvents for [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Create](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Create.html), when performing this transaction.

The Resource Notification Recipient, when grouped with [ATNA](https://profiles.ihe.net/ITI/TF/Volume1/ch-9.html) Secure Node or Secure Application Actor, shall be able to record fundamental AuditEvents for [BALP](https://profiles.ihe.net/ITI/BALP/index.html) [Create](https://profiles.ihe.net/ITI/BALP/1.1.2/StructureDefinition-IHE.BasicAudit.Create.html), when performing this transaction.
