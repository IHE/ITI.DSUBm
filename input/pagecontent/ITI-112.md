This section corresponds to transaction [ITI-112] Resource Notify of the IHE Technical Framework. Transaction [ITI-112] Resource Notify is used by the Resource Notification Broker and Resource Notification Recipient. The [ITI-112] transaction is used to notify a publication event that matches subscription criteria.

### 3.112.1 Scope Scope

The Resource Notify [ITI-112] transaction passes a Notification Bundle Request from a Resource Notification Broker to a Resource Notification Recipient. This transaction is used to inform the Resource Notification Recipient that a publication event matches the subscription criteria from an active Subscription resource. 

### 3.112.2 Actors Roles

**Table: Actor Roles**

|Actor | Role |
|-------------------+--------------------------|
| [Resource Notification Broker](volume-1.html#broker)    | Sends the Notification Bundle Request to the Resource Notification Recipient |
| [Resource Notification Recipient](volume-1.html#recipient) | Receives the notification |

### 3.112.3 Referenced Standards

**FHIR-R4B** [HL7 FHIR Release 4.3.0](https://www.hl7.org/FHIR/R4B)

### 3.112.4 Interactions

<figure>
{%include ITI-112-Notification-seq.svg%}
<figcaption><b>Figure 2:3.112: ITI-112 interactions</b></figcaption>
</figure>
<br clear="all">

**Figure: Go Interactions**


#### 3.112.5 Notification Bundle Request
This message uses the HTTP POST method on the target Resource Notification Recipient endpoint to submit the bundle resource.

##### 3.112.5.1 Trigger Events

This transaction is invoked when Resource Notification Broker has been aware of a publication event or it has received a Resource Publish [ITI-111] that matches one (or more) subscription criteria included in the subscription resources with `status="active"` . 

##### 3.112.5.2 Message Semantics

The Resource Notification Broker shall initiate an HTTP request according to requirements defined in the HL7® FHIR® standard for “create” interaction (https://hl7.org/fhir/R4B/http.html#create). The message uses an HTTP POST method to submit a [Bundle](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-subscription-notification.html) FHIR Resource with the `Bundle.type = history`. In this way, the Bundle will contain the change on the Fhir resource triggered by the publication event or the resource contained in the Bundle of the Resource Publish [ITI-111].

The notification Bundle MUST have a SubscriptionStatus as the first entry. This element is necessary to describe during notifications the state of the Subscription that has been triggered.



The content of the notification is based on the `SubscriptionTopic.notificationShape` which indicates which resource shall be included in the notification. 
The notification shall include: one or more DocumentReference resource(as defined [here](https://profiles.ihe.net/ITI/MHD/ITI-65.html#2-3-65-provide-document-bundle-iti-65)) and zero or more  Folder type List Resources (as defined [here](https://profiles.ihe.net/ITI/MHD/StructureDefinition-IHE.MHD.Comprehensive.Folder.html)) and zero or more SubmissionSet type List Resources (as defined [here](https://profiles.ihe.net/ITI/MHD/StructureDefinition-IHE.MHD.Comprehensive.SubmissionSet.html)).

The level of detail of these resources, that the Resource Notification Broker should use in the Notification Bundle, is indicated in the `Subscription.payload` element. For this element are possible 3 different types of values: empty, id-only, and full-resource as defined by this [extension](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/StructureDefinition-backport-payload-content.html#root).

The Notification Bundle Request message is sent to the endpoint indicated in the `Subscription.channel.endpoint`.

The `content-type` of the POST shall match the MIME type on the `Subscription.channel.payload` element 


##### 3.112.5.3 Expected Actions

The Resource Notification Recipient processes the results according to application-defined rules.
The Resource Notification Recipient may handle errors if detected.

#### 3.112.6 Notification Bundle Response

The Resource Notification Recipient sends a Notification Bundle Response message to respond to a Notification Bundle Request message.

##### 3.112.6.1 Trigger Events

When the Resource Notification Recipient receives the notification sends this message to the Resource Notification Broker acknowledging the reception of the notification.

##### 3.112.6.2 Message Semantics

When the Resource Notification Recipient has processed the request, it shall return an HTTP response with an overall status code.

The Resource Notification Recipient returns an HTTP status code appropriate to the processing of the create request. If the notification has been received and processed the Resource Notification Recipient shall respond with an `HTTP 201 Created` status code as indicated in https://hl7.org/fhir/R4B/http.html#create.Otherwise, if the reception or processing of the notification has failed the Resource Notification Recipient shall respond with `HTTP 400 Bad Request`.


##### 3.112.6.3 Expected Actions

The Resource Notification Recipient may handle errors like missed notifications and broken connections by using the $event and $status operations on the transaction Resource Subscription Search [ITI-113] as defined [here](https://build.fhir.org/ig/HL7/fhir-subscription-backport-ig/errors.html#handling-errors).


### CapabilityStatement Resource

The Server implementing this transaction shall provide a CapabilityStatement Resource as described in ITI TF-2x: Appendix Z.3 indicating the transaction has been implemented. 
* Requirements CapabilityStatement for [Client](CapabilityStatement-IHE.ToDo.client.html)
* Requirements CapabilityStatement for [Server](CapabilityStatement-IHE.ToDo.server.html)

### Security Considerations

See [DSUBm Security Considerations](volume-1.html#security-considerations). 

The Resource Notification Broker should confirm that the Resource Notification Recipient is still authorized to receive the information that it is searching for. If Authorization Token is used to verify the autorization of a Recipient to receive notification the Resource Notification Broker shall also verify that this tokes has not been revoked before sending the Notification Bundle Request message. 

The Resource Notification Recipient should be defensive and robust to a malicious client that may send a large volume of fake notifications with empty notifications, which would cause the Resource Notification Recipient to send many (potentially expensive) queries to a server.



#### Security Audit Considerations

''TODO: The security audit criteria ''

##### Client Audit 

''TODO: the specifics''

##### Server Audit 

''TODO: the specifics''
